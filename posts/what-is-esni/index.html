<!doctype html><html lang=ko dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI | Pol4bear's blog</title>
<meta name=keywords content="λ„¤νΈμ›ν¬ λ³΄μ•,ESNI,μ ν•΄μ‚¬μ΄νΈ μ°¨λ‹¨"><meta name=description content="ESNIμ— λ€ν•΄ μ•μ•„λ³΄μ"><meta name=author content="Pol4bear"><link rel=canonical href=https://pol4.dev/posts/what-is-esni/><meta name=google-site-verification content="G-73Y2WPXWJK"><link crossorigin=anonymous href=/assets/css/stylesheet.5c25c975546c048d1a5600aadb48425ae1bc921a9a18fe67d6955c9535260811.css integrity="sha256-XCXJdVRsBI0aVgCq20hCWuG8khqaGP5n1pVclTUmCBE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://pol4.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://pol4.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://pol4.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://pol4.dev/apple-touch-icon.png><link rel=mask-icon href=https://pol4.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-73Y2WPXWJK"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-73Y2WPXWJK",{anonymize_ip:!1})}</script><meta property="og:title" content="μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI"><meta property="og:description" content="ESNIμ— λ€ν•΄ μ•μ•„λ³΄μ"><meta property="og:type" content="article"><meta property="og:url" content="https://pol4.dev/posts/what-is-esni/"><meta property="og:image" content="https://pol4.dev/posts/what-is-esni/esni.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-03T16:11:28+09:00"><meta property="article:modified_time" content="2020-03-03T16:11:28+09:00"><meta property="og:site_name" content="Pol4bear's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pol4.dev/posts/what-is-esni/esni.png"><meta name=twitter:title content="μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI"><meta name=twitter:description content="ESNIμ— λ€ν•΄ μ•μ•„λ³΄μ"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://pol4.dev/posts/"},{"@type":"ListItem","position":3,"name":"μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI","item":"https://pol4.dev/posts/what-is-esni/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI","name":"μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI","description":"ESNIμ— λ€ν•΄ μ•μ•„λ³΄μ","keywords":["λ„¤νΈμ›ν¬ λ³΄μ•","ESNI","μ ν•΄μ‚¬μ΄νΈ μ°¨λ‹¨"],"articleBody":"μ„λ΅  2019λ…„ 3μ›” μ°λ¦¬λ‚λΌμ—μ„ SNI κΈ°λ°μ μ ν•΄μ‚¬μ΄νΈ λ°©μ‹μ΄ μ μ©λκ³ λ‚μ„ GoodbyeDPI, μ¤λ‚μ΄νΌ, μ λ‹μ½ λ“±κ³Ό λ”λ¶μ–΄ ESNIκ°€ μƒλ΅μ΄ μ ν•΄μ‚¬μ΄νΈ μ°¨λ‹¨ μ°ν λ°©μ‹μΌλ΅ μ‚¬μ©λκ³  μλ‹¤. μ•„λ¬΄λ¦¬ ESNIκ°€ κ°μΈμ •λ³΄ μΉ¨ν•΄λ¥Ό λ§‰μ•„μ¤€λ‹¤κ³  ν•μ§€λ§ μΈν„°λ„· κ²€μ—΄μ„ ν•μ§€ μ•λ” λ‚λΌλ“¤μ€ ν•„μ”λ΅ ν•μ§€ μ•μ„ κ²ƒμ΄κ³ , κ²€μ—΄μ„ ν•λ” λ‚λΌλ“¤μ€ μ°λ¦¬λ‚λΌμ™€λ” λΉ„κµν•μ§€ λ»ν•  λ§νΌ λ” μ„Έκ² κ²€μ—΄ν•κΈ° λ•λ¬Έμ— μ°λ¦¬λ‚λΌλ¥Ό μ μ™Έν• λ‹¤λ¥Έ λ‚λΌλ“¤μ—μ„λ” κ·Έλ‹¤μ§€ λ§¤λ ¥μλ” κΈ°μ μ΄ μ•„λ‹ κ²ƒ κ°™λ‹¤.\nESNIλ” ν”„λΌμ΄λ²„μ‹μ μΌλ΅ μ •λ§ μΆ‹μ€ κΈ°μ μΈ κ²ƒ κ°™λ‹¤. λν• SNI μ°¨λ‹¨ μ¥λΉ„λ“¤μ΄ μ—…λ°μ΄νΈλμ–΄ μ°νν•  μ μλ” λ°©λ²•μ΄ ESNIμ™€ VPNμ΄λ‚ ν”„λ΅μ‹λ°–μ— λ‚¨μ§€ μ•λ”λ‹¤λ©΄ νΉν μ°λ¦¬λ‚λΌ μ‚¬λλ“¤μ—κ²λ” μ‚¬λ‘λ°›λ” κΈ°μ μ΄ λ  κ²ƒμ΄λ‹¤. ESNIκ°€ ν‘μ¤€μΌλ΅ λ°μ „ν•κ³  κ³µμ‹μ μΌλ΅ μ‚¬μ©λκΈ° μ‹μ‘ν•λ‹¤λ©΄ μ•”νΈν™”λ λ‚΄μ©μ„ λ³µνΈν™”ν•΄λ³Ό μ μ—†λ” μ°λ¦¬λ‚λΌμ—μ„λ” μ ν•΄μ‚¬μ΄νΈλ¥Ό μ°¨λ‹¨ν•κΈ° μ–΄λ ¤μΈ(λ¶κ°€λ¥ν•λ‹¤κ³ λ” ν•μ§€ μ•κ² λ‹¤) κ²ƒμ΄λ‹¤. μ•„λ§ μ΅°λ§κ°„ λΉλ²ν•κ² μ‚¬μ©λ  ESNIλ€ κΈ°μ μ— λ€ν•΄μ„ ν•λ² μ•μ•„λ³΄μ.\nSNIλ€? ESNIμ— λ€ν•΄ μ•μ•„λ³΄κΈ° μ „μ— SNIλ¥Ό λ¨Όμ € μ•μ•„μ•Ό ν•λ‹¤. HTTPSκ°€ ν†µμ‹ μ—μ„ ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„μ™€ ν†µμ‹  μ „μ— μ–΄λ–¤ λ°©μ‹μΌλ΅ μ•”νΈν™”ν• μ§€, μ–΄λ–¤ λ°©μ‹μΌλ΅ ν‚¤λ¥Ό κµν™ν• μ§€, μ–΄λ–¤ SSL/TLS λ²„μ „μ„ μ‚¬μ©ν• μ§€ μ •ν•κΈ° μ„ν•΄ Handshake ν†µμ‹ μ„ μ§„ν–‰ν•λ‹¤.\nHandshake κ³Όμ •μ—μ„ ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„μ μΈμ¦μ„λ¥Ό μ „μ†΅λ°›κ² λλ”λ° κ·Έ μΈμ¦μ„λ΅ μμ‹ μ΄ λ§λ” μ„λ²„λ΅ μ ‘μ†ν•λ” κ²ƒμΈμ§€ κ²€μ¦ν•κ² λλ‹¤. μ„λ²„λ” ν΄λΌμ΄μ–ΈνΈμ—κ² μ μ ν• μΈμ¦μ„λ¥Ό μ „μ†΅ν•΄μ¤μ•Ό ν•λ‹¤. μλ¥Ό λ“¤μ–΄ ν•λ‚μ μ„λ²„μ—μ„ νμ΄μ¤λ¶κ³Ό νΈμ„ν„° λ‘ κ°μ μ„λΉ„μ¤λ¥Ό μ κ³µν•λ‹¤κ³  μƒκ°ν•΄λ³΄μ. ν΄λΌμ΄μ–ΈνΈκ°€ μ—°κ²°ν•  λ• μ–΄λ””μ— μ ‘μ†ν•λ”μ§€ ν‘μ‹λ¥Ό ν•΄λ‘μ§€ μ•λ”λ‹¤λ©΄ μ„λ²„λ” νμ΄μ¤λ¶, νΈμ„ν„° λ‘ μ¤‘ μ–΄λ–¤ μΈμ¦μ„λ¥Ό μ „μ†΅ν•  μ§€ κ²½μ •ν•  μ μ—†μ„ κ²ƒμ΄λ‹¤. μ΄ λ¬Έμ λ¥Ό ν•΄κ²°ν•κΈ° μ„ν•΄ TLS extensionμΈ SNI(Server Name Indication)κ°€ RFC 3546μ—μ„ λ“±μ¥ν–λ‹¤.\nβ€server_nameβ€ extension β€server_nameβ€ extensionμ Typeμ€ 00 00μ΄λ‹¤. μ²« 4λ°”μ΄νΈ Typeκ³Ό μ „μ²΄ κΈΈμ΄λ” λ¨λ“  TLS extensionμ΄ κ³µν†µμ μΌλ΅ κ°€μ§„ ν•„λ“λ‹¤.\nESNIλ€? SNIκ°€ μ‚¬μ©λκΈ° μ‹μ‘ν•λ©΄μ„ μ„λ²„ λΏλ§μ΄ μ•„λ‹λΌ μ  3μλ„ ν΄λΌμ΄μ–ΈνΈκ°€ μ–΄λ””μ— μ ‘μ†ν•λ ¤λ”μ§€ μ‰½κ² μ•μ•„λ‚Ό μ μλ‹¤λ” λ‹¨μ μ΄ μƒκ²Όλ‹¤. ν†µμ‹ λλ” λ‚΄μ© μμ²΄λ” μ•”νΈν™”λμ–΄ μ• μ μ—†λ‹¤κ³  ν•λ”λΌλ„ β€μ–΄λ–¤ IP μ£Όμ†λ¥Ό κ°€μ§„ μ‚¬λμ΄ μ–΄λ–¤ μ‚¬μ΄νΈμ— λΉλ²ν•κ² μ ‘μ†ν•λ”λΌβ€ μ΄λ° μ‹μΌλ΅ ν΄λΌμ΄μ–ΈνΈκ°€ μ–΄λ””μ— μ ‘μ†ν•λ”κ°€λ§ μμ§‘ν•λ”λΌλ„ μ¶©λ¶„ν κ°μΈμ •λ³΄ μΉ¨ν•΄κ°€ λ  μ μλ‹¤. μ‹¤μ λ΅ μ°λ¦¬λ‚λΌλ” 2019λ…„ 3μ›”κ²½ HTTP Host ν•„λ“λ¥Ό λ³΄κ³  μ ν•΄μ‚¬μ΄νΈλ¥Ό μ°¨λ‹¨ν•΄μ„ HTTPSλ” μ°¨λ‹¨ν•  μ μ—†μ—λ μƒν™©μ—μ„ SNI λ¥Ό μ κ·Ήμ μΌλ΅ μ΄μ©ν• SNI μ°¨λ‹¨λ°©μ‹μ„ μ‚¬μ©ν•μ—¬ HTTPS ν†µμ‹  λν• μ°¨λ‹¨ν•κ³  μλ‹¤. μ™Έκµ­μ—μ„λ„ μ΄λ° κ°μΈμ •λ³΄ μΉ¨ν•΄ κ΄€λ ¨ν•΄μ„ λ¬Έμ κ°€ μμ—λ”μ§€ μ΄ SNI μ •λ³΄λ¥Ό μ•”νΈν™”ν•  μ μλ” ESNI Extensionμ΄ λ“±μ¥ν–λ‹¤.\nEncrypted Server Name Indication μ¦‰, ESNIλ” μ•„μ§ TLS 1.3μ ν‘μ¤€μ΄ μ•„λ‹ draftμΈ μƒνƒλ‹¤. λ€λ¶€λ¶„μ SSL/TLS λΌμ΄λΈλ¬λ¦¬κ°€ μ•„μ§ ESNIλ¥Ό μ§€μ›ν•κ³  μμ§€ μ•μ§€λ§, Mozillaμ Firefox λΈλΌμ°μ €λ¥Ό μ΄μ©ν•λ©΄ ESNIλ¥Ό μ‚¬μ©ν•  μ μλ‹¤. μ„λ²„μ κ²½μ° Cloudflareμ ν”„λ΅μ‹λ¥Ό μ‚¬μ©ν•λ©΄ μ μ©μ΄ κ°€λ¥ν•λ‹¤.\nESNIμ ν•µμ‹¬μ μΈ λ‚΄μ©μ€ TLS ν†µμ‹ μ΄ μ΄λ£¨μ–΄μ§€κΈ° μ „ μ–΄λ–»κ² ν‚¤λ¥Ό κµν™ν•  κ²ƒμΈμ§€λ‹¤. κ²°κµ­ SNIλ¥Ό μ•”νΈν™”ν•λ ¤λ©΄ μ•”νΈν™” ν‚¤κ°€ ν•„μ”ν•λ° ESNIλ” μ΄ ν‚¤ κ΄€λ ¨ λ¬Έμ λ¥Ό TLS ν†µμ‹  μ „ DNS μ„λ²„μ—μ„ λ°›μ•„μ¤λ” λ°©μ‹μΌλ΅ μ΄ λ¬Έμ λ¥Ό ν•΄κ²°ν–λ‹¤. ESNIμ λ™μ‘ λ°©μ‹μ€ λ‹¤μκ³Ό κ°™λ‹¤.\nESNIμ λ™μ‘ λ°©μ‹ 1. μ„λ²„ - ESNI λ μ½”λ“ DNS μ„λ²„μ— λ³΄κ΄€ν•κΈ° ESNIλ¥Ό μ κ³µν•  μ„λ²„λ” ESNI λ μ½”λ“ μƒμ„±μ— μ•μ„ SNI μ•”νΈν™” ν‚¤ μƒμ„±μ— μ‚¬μ©λ  μμ‹ μ ν‚¤ μμ„ μƒμ„±ν•λ‹¤. κ·Έλ¦¬κ³ , μ•μ„ μƒμ„±ν• μμ‹ μ ν‚¤ μ μ¤‘ κ³µκ° ν‚¤μ™€ ESNI λ²„μ „, Cipher Suite, μ ν¨κΈ°κ°„ λ“± SNIλ¥Ό μ•”νΈν™”ν•  λ• ν•„μ”ν• μ •λ³΄λ“¤μ΄ ν¬ν•¨λ ESNI λ μ½”λ“λ¥Ό μƒμ„±ν• ν›„ Base 64λ΅ μΈμ½”λ”©ν•΄μ„ DNS μ„λ²„μ— λ³΄κ΄€ν•λ‹¤. λ‹¨, ESNI λ μ½”λ“λ” _esni.[νΈμ¤νΈ μ΄λ¦„]μ— TXT λ μ½”λ“λ΅ λ³΄κ΄€ν•΄μ•Ό ν•λ‹¤.\n_esni.pol4.dev. IN TXT /wEvzh0pACQAHQAgMU5QtkenanuH/Oq2R5sZGt1O8zzZWhUBqala5sduaUIAAhMBAQQAAAAAXlkO0AAAAABeYPfQAAA= 2. ν΄λΌμ΄μ–ΈνΈ - DNS μ„λ²„μ—μ„ ESNI λ μ½”λ“ κ°€μ Έμ¤κΈ° ν΄λΌμ΄μ–ΈνΈλ” SNI μ•”νΈν™”μ— μ•μ„ DNS μ„λ²„μ— λ³΄κ΄€λμ–΄ μλ” ESNI λ μ½”λ“λ¥Ό κ°€μ Έμ™€μ•Ό ν•λ‹¤. μ„λ²„μ IPλ¥Ό μ–»μ–΄μ¤λ” DNSμ§μμ™€λ” λ³„κ°λ΅ TXT λ μ½”λ“λ΅ μ €μ¥λμ–΄ μλ” ESNI λ μ½”λ“λ¥Ό κ°€μ Έμ™€μ„ ESNI λ²„μ „κ³Ό ESNI λ μ½”λ“κ°€ λ§λ£λμ§€λ” μ•μ•λ”μ§€ ν™•μΈν•κ³ , SNI μ•”νΈν™” ν‚¤ μƒμ„±μ— μ‚¬μ©λλ” μ„λ²„μ κ³µκ° ν‚¤λ¥Ό μ–»μ–΄λ‚Έλ‹¤.\n3. ν΄λΌμ΄μ–ΈνΈ - ESNIλ¥Ό ν¬ν•¨ν• Client Hello μ „μ†΅ν•κΈ° ν΄λΌμ΄μ–ΈνΈλ” DNS μ„λ²„μ—μ„ κ°€μ Έμ¨ ESNI λ μ½”λ“μ μ„λ²„ κ³µκ° ν‚¤μ™€ κ³µμ  λΉ„λ°€μ„ μ‚¬μ©ν•κΈ° μ„ν• μ„μ‹ ν‚¤ μμ„ μƒμ„±ν•λ‹¤. μƒμ„±ν• μ„μ‹ ν‚¤μ™€ μ„λ²„ κ³µκ° ν‚¤λ¥Ό μ΄μ©ν•΄ μƒμ„±ν• κ³µμ  λΉ„λ°€λ΅ SNI μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•΄μ„ SNIλ¥Ό μ•”νΈν™”ν•λ‹¤. μ•”νΈν™”λ SNIλ” Client Helloμ β€encrypted_server_nameβ€ extensionμ— ν¬ν•¨μ‹μΌ μ„λ²„μ— μ „μ†΅ν•λ‹¤.\n4. μ„λ²„ - μ•”νΈν™”λ SNI λ³µνΈν™”ν•κ³  Server Hello μ „μ†΅ν•κΈ° μ„λ²„λ” Client Helloμ β€encrypted_server_nameβ€ extensionμ— μλ” ν΄λΌμ΄μ–ΈνΈ μ„μ‹ κ³µκ° ν‚¤μ™€ ESNI κ°μΈ ν‚¤(ESNI λ μ½”λ“μ μ„λ²„ κ³µκ° ν‚¤μ™€ μ)λ¥Ό μ΄μ©ν•μ—¬ SNI μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•λ‹¤. μƒμ„±ν• μ•”νΈν™” ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ μ•”νΈν™”λ SNIλ¥Ό λ³µνΈν™”ν• λ’¤ κ·Έμ— λ§λ” Server Helloλ¥Ό ν΄λΌμ΄μ–ΈνΈμ—κ² μ „μ†΅ν•λ‹¤.\nβ€encrypted_server_nameβ€ extension μ„μ™€ κ°™μ€ κ³Όμ •μ„ κ±°μΉλ©΄ Client Helloμ— β€encrypted_server_nameβ€ extensionμ„ μ‚¬μ©ν•  μ μκ² λλ‹¤. ESNI μ΄μ• 5. The β€encrypted_server_nameβ€ extensionμ— λ”°λ¥΄λ©΄ TLS extension Type ff ceμΈ β€encrypted_server_nameβ€ extensionμ κµ¬μ΅°λ” λ‹¤μκ³Ό κ°™λ‹¤.\nstruct { CipherSuite suite; KeyShareEntry key_share; opaque record_digest\u003c0..2^16-1\u003e; opaque encrypted_sni\u003c0..2^16-1\u003e; } ClientEncryptedSNI; CipherSuite suite: μ•”νΈν™”μ— μ‚¬μ©λ Cipher Suite KeyShareEntry key_share: SNI μ•”νΈν™” ν‚¤ μƒμ„±μ— μ‚¬μ©λ Key Share opaque record_digest: SNI ν‚¤ μƒμ„±μ— μ‚¬μ©ν• ESNIKeysμ ν•΄μ‰¬κ°’ ν•΄μ‰¬ μ•κ³ λ¦¬μ¦μ€ Cipher Suiteμ— ν¬ν•¨λμ–΄ μλ‹¤. opaque encrypted_sni: μ•”νΈν™”λ SNI μ‹¤μ  ESNIλ¥Ό μ‚¬μ©ν–μ„ λ• β€encrypted_server_nameβ€ extensionμ€ λ‹¤μκ³Ό κ°™λ‹¤.\nESNI μμ„Έν μ•μ•„λ³΄κΈ° ESNI λ μ½”λ“ ESNI μ΄μ• 4.1 μ•”νΈν™”λ SNI λ μ½”λ“μ— λ”°λ¥΄λ©΄ ESNI λ μ½”λ“μ κµ¬μ΅°λ” λ‹¤μκ³Ό κ°™λ‹¤.\n// Copied from TLS 1.3 struct { NamedGroup group; opaque key_exchange\u003c1..2^16-1\u003e; } KeyShareEntry; struct { uint16 version; opaque public_name\u003c1..2^16-1\u003e; KeyShareEntry keys\u003c4..2^16-1\u003e; CipherSuite cipher_suites\u003c2..2^16-2\u003e; uint16 padded_length; Extension extensions\u003c0..2^16-1\u003e; } ESNIKeys; struct { ESNIKeys esni_keys; Extension dns_extensions\u003c0..2^16-1\u003e; } ESNIRecord; KeyShareEntry κµ¬μ΅° ESNIKeys κµ¬μ΅°μ²΄ SNIλ¥Ό μ•”νΈν™”ν•λ”λ° μ‹¤μ  μ‚¬μ©λλ” ν‚¤μ™€ μΌλ¶€ λ©”νƒ€λ°μ΄ν„°λ¥Ό ν¬ν•¨ν•λ‹¤.\nuint16 version: μ ‘μ†μ— μ‚¬μ©ν•΄μ•Όν•λ” ESNI λ²„μ „\nopaque public_name: μ•”νΈν™” ν‚¤λ¥Ό κ°±μ‹ ν•κΈ° μ„ν•΄ μ‚¬μ©λλ” μ‹ λΆ°ν•  μ μλ” κ°μ²΄μ μ΄λ¦„\nμλ»λ μ„¤μ •μ„ λλλ¦΄ λ• μ“°μΈλ‹¤. KeyShareEntry keys: ESNI μ—°κ²°μ— μ‚¬μ©ν•  μ μλ” μ„λ²„ κ³µκ° ν‚¤ λ©λ΅\nκ° ν‚¤λ“¤μ€ λ‹¤λ¥Έ κ·Έλ£Ήμ„ κ°€μ§€κ³  μμ–΄μ•Όν•λ‹¤. CipherSuite cipher_suites: SNI μ•”νΈν™”μ— μ‚¬μ©ν•  μ μλ” Cipher Suite λ©λ΅\nuint16 padded_length: SNIλ¥Ό μ•”νΈν™”ν•κΈ° μ „ ν¨λ”©ν• μ„λ²„ μ΄λ¦„ λ©λ΅μ ν¬κΈ°\nμ„λ²„κ°€ μ§€μ›ν•  κ²ƒμΌλ΅ μμƒλλ” κ°€μ¥ ν° μ„λ²„ μ΄λ¦„ λ©λ΅μ„ 16μ λ°°μμ™€ κ°€κΉκ² λ°μ¬λ¦Όν• ν¬κΈ°μ™€ κ°™κ² μ„¤μ •ν•΄μ•Όν•λ‹¤. λ§μ•½ μ„λ²„κ°€ μ„μμ μ™€μΌλ“μΉ΄λ“ μ„λ²„ μ΄λ¦„λ“¤μ„ μ§€μ›ν•λ‹¤λ©΄ 260μΌλ΅ μ„¤μ •ν•΄μ•Όν•λ‹¤. ν΄λΌμ΄μ–ΈνΈλ” padded_lengthκ°€ 260λ³΄λ‹¤ ν΄ κ²½μ° ESNIKeysλ¥Ό λ¬΄μ‹ν•΄μ•Όν•λ‹¤. ν¨λ”©μ„ ν•μ—¬ μ„λ²„ μ΄λ¦„ λ©λ΅μ κΈΈμ΄λ¥Ό κ³ μ •μ‹ν‚¤λ” μ΄μ λ” κ³µκ²©μκ°€ μ•”νΈν™”λ μ„λ²„ μ΄λ¦„ λ©λ΅μ κΈΈμ΄λ΅ μ„λ²„ μ΄λ¦„μ„ μμΈ΅ν•  μ μ—†κ² λ§λ“¤κΈ° μ„ν•΄μ„λ‹¤. Extension extensions: ν΄λΌμ΄μ–ΈνΈκ°€ Client Helloλ¥Ό λ§λ“λ”λ° μ‚¬μ©ν•  μ μλ” TLS extensionμ λ©λ΅\nν–¥ν›„ μ¶”κ°€μ μΈ κΈ°λ¥μ„ μ κ³µν•κΈ° μ„ν• κ³µκ°„μΌλ΅ μ‚¬μ©ν•λ‹¤. extensionμ€ Typeμ MSBλ¥Ό 1λ΅ μ„¤μ •ν•¨μΌλ΅μ¨ Client Hello ν•„μμ μΌλ΅ ν¬ν•¨μ‹ν‚¤κ² ν•  μ μλ‹¤. ν΄λΌμ΄μ–ΈνΈλ” ν•„μ extensionμΌλ΅ μ„¤μ •λ extension μ¤‘ extensionμ΄ μμΌλ©΄ ν•΄λ‹Ή ESNIKeysλ¥Ό λ¬΄μ‹ν•΄μ•Όν•λ‹¤. ESNIRecord κµ¬μ΅°μ²΄ ESNIKeys esni_keys: SNIλ¥Ό μ•”νΈν™”ν•λ”λ° μ‹¤μ  μ‚¬μ©λλ” ν‚¤μ™€ κ·Έ ν‚¤μ™€ κ΄€κ³„λ μ—¬λ¬ λ©”νƒ€λ°μ΄ν„°λ“¤ Extension extensions: ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„μ DNS μ΄λ¦„μ„ μ§μν• λ• μ°Έκ³ ν•  μ μλ” TLS extensionμ λ©λ΅ ν–¥ν›„ μ¶”κ°€μ μΈ κΈ°λ¥μ„ μ κ³µν•κΈ° μ„ν• κ³µκ°„μΌλ΅ μ‚¬μ©ν•λ‹¤. extensionμ€ Typeμ MSBλ¥Ό 1λ΅ μ„¤μ •ν•¨μΌλ΅μ¨ Client Hello ν•„μμ μΌλ΅ ν¬ν•¨μ‹ν‚¤κ² ν•  μ μλ‹¤. ν΄λΌμ΄μ–ΈνΈλ” ν•„μ extensionμΌλ΅ μ„¤μ •λ extension μ¤‘ extensionμ΄ μμΌλ©΄ ν•΄λ‹Ή ESNI λ μ½”λ“λ¥Ό λ¬΄μ‹ν•΄μ•Όν•λ‹¤. μ¶”κ°€ μ •λ³΄ μ„λ²„λ” μ—¬λ¬κ°μ ESNI λ μ½”λ“λ¥Ό μ κ³µν•¨μΌλ΅μ¨ μ—¬λ¬ λ²„μ „μ ESNIλ¥Ό μ κ³µν•  μ μλ‹¤. ESNI λ μ½”λ“λ“¤ μ¤‘ ν΄λΌμ΄μ–ΈνΈκ°€ λ¨λ¥΄λ” ESNI λ²„μ „μ„ κ°€μ§„ ESNI λ μ½”λ“κ°€ μλ‹¤λ©΄ ν΄λΌμ΄μ–ΈνΈλ” κ·Έ λ μ½”λ“λ¥Ό λ¬΄μ‹ν•΄μ•Όν•λ‹¤. ν•μ§€λ§ λ€λ¶€λ¶„μ μ„λ²„κ°€ ν•λ‚μ ESNI λ μ½”λ“λ§ μ „μ†΅ν•΄μ£Όλ” μƒνƒλ‹¤.\nESNI μ΄μ• 05 λ²„μ „μ—μ„ ESNIKeysλ” ESNIConfigλ΅ μ©μ–΄κ°€ λ³€κ²½λμ—λ‹¤. λν•, DNSλ¥Ό μ΄μ©ν•λ” λ°©λ²•μ€ HTTPSSVCλΌλ” DNSλ¥Ό μ΄μ©ν•΄μ„ μ¶”κ°€μ μΈ μ •λ³΄λ¥Ό μ κ³µν•λ” QUIC, ESNI λ“± κΈ°μ λ“¤μ„ μ„ν• κΈ°μ μ„ μ‚¬μ©ν•λ” κ²ƒμΌλ΅ λ³€κ²½λμ—λ‹¤. ν•μ§€λ§ μ•„μ§κΉμ§„ 01 λ²„μ „ λ“± μ΄μ „ λ²„μ „μ μ΄μ•μΌλ΅ κµ¬ν„λμ–΄ μ΄μ©λκ³  μλ‹¤. ESNIλ„ κ·Έλ ‡κ³  HTTPSSVCλ„ κ·Έλ ‡κ³  μ•„μ§ μ΄μ•μΈ λ§νΌ μ–΄λ–»κ² λ³€κ²½λ μ§€λ” μ•„λ¬΄λ„ λ¨λ¥Έλ‹¤.\nESNI λ μ½”λ“μ—μ„ μ •λ³΄ μ·¨λ“ν•κΈ° ESNI λ μ½”λ“ κ°€μ Έμ¤κΈ° λ°μ΄ν„°λ¥Ό νμ‹±ν•  ENSI λ μ½”λ“λ” λ‹¤μ λ…λ Ήμ–΄λ΅ κ°€μ Έμ¬ μ μλ‹¤. μ•„λ λ…λ Ήμ–΄λ΅ κ°€μ Έμ¨ ESNI λ μ½”λ“λ” Base 64λ΅ μΈμ½”λ”©λμ–΄μλ” μƒνƒλ‹¤.\nnslookup -type=txt _esni.cloudflare.com ESNI λ μ½”λ“ λ””μ½”λ”©ν•κΈ° ESNI λ μ½”λ“λ¥Ό μ²μ κ°€μ Έμ¤λ©΄ Base 64λ΅ μΈμ½”λ”©λμ–΄μλ‹¤. κ°€μ Έμ¨ ESNI λ μ½”λ“λ¥Ό λ””μ½”λ”©ν•΄μ„ μ‹¤μ  ESNI λ μ½”λ“ κ°’μ„ μ–»μ–΄λ‚Ό μ μλ‹¤. λ²„ν”„ μνΈμ Decoderλ¥Ό μ‚¬μ©ν•λ©΄ μ‰½κ² λ””μ½”λ”©ν•  μ μλ‹¤.\nESNI λ μ½”λ“μ—μ„ μ •λ³΄ μ·¨λ“ν•κΈ° ESNI λ μ½”λ“ λ””μ½”λ”©ν•κΈ°λ¥Ό ν†µν•΄ μ–»μ€ ESNI λ μ½”λ“λ” λ‹¤μκ³Ό κ°™λ‹¤.\nff 01 13 0f a6 4a 00 24 00 1d 00 20 3f 3e c9 d5 c4 62 f9 4e 1b 81 a3 cd f2 ca 4d bb 98 fa 78 2c cc 88 8b ce 82 98 1c 33 f6 12 c7 5f 00 02 13 01 01 04 00 00 00 00 5e 5a 1a 00 00 00 00 00 5e 62 03 00 00 00 DNSμ— μ¬λΌκ°€μλ” ESNI λ μ½”λ“λ” ESNIKeys κµ¬μ΅°μ²΄μ™€ λ‹¤λ¥΄κ² μ²΄ν¬μ„¬κ³Ό κΈΈμ΄ ν•„λ“λ“¤μ΄ μ¶”κ°€λμ–΄μλ‹¤. ESNI λ μ½”λ“μ λ¨λ“  μ«μ ν•μ‹ λ°μ΄ν„°μ λ°”μ΄νΈ μ¤λ”λ” λΉ… μ—”λ””μ–ΈμΌλ΅ λμ–΄μλ‹¤. ESNI λ μ½”λ“λ” μ•„λ ν…μ΄λΈ”κ³Ό κ°™μ€ κµ¬μ΅°λ¥Ό μ·¨ν•κ³  μλ‹¤.\nESNI λ μ½”λ“μ—μ„ μ •λ³΄λ¥Ό μ·¨λ“ν•  λ• ν•„λ“ λ³„λ΅ ν™•μΈν•  κ²ƒμ€ λ‹¤μκ³Ό κ°™λ‹¤.\nESNIKeysμ μ²΄ν¬μ„¬μ„ 0μΌλ΅ μ±„μ΄ λ’¤ SHA 256μΌλ΅ ν•΄μ‰¬ν• ν•΄μ‰¬κ°’μ μµμƒμ„ 4λ°”μ΄νΈμ™€ κΈ°μ΅΄ μ²΄ν¬μ„¬μ΄ λ‹¤λ¥΄λ‹¤λ©΄ λ³€μ΅°λ λ°μ΄ν„°λ‹¤. Keysλ” λ³µμμ KeyShareEntryλ΅ μ΄λ£¨μ–΄μ Έ μλ‹¤. Not Before, Not Afterμ€ Unix timeμΌλ΅ λμ–΄μλ‹¤. μ„ κµ¬μ΅°λ¥Ό λ”°λΌ ESNI λ μ½”λ“μ—μ„ μ·¨λ“ν• μ •λ³΄λ” λ‹¤μκ³Ό κ°™λ‹¤.\nSNI μ•”νΈν™” ν‚¤ μƒμ„± SNIλ¥Ό μ•”νΈν™”ν•κΈ°μ— μ•μ„ μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•΄μ•Όν•λ‹¤. μ„λ²„λΌλ©΄ Client Helloλ΅, ν΄λΌμ΄μ–ΈνΈλΌλ©΄ DNSμ—μ„ λ°›μ•„μ¨ ESNIKeysλ΅ μƒλ€λ°©μ κ³µκ°ν‚¤λ¥Ό κ°€μ§€κ³  μμ„ κ²ƒμ΄λ‹¤. SNI μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±μ„ μ„ν•΄ μμ‹ μ κ°μΈν‚¤μ™€ μƒλ€λ°©μ κ³µκ°ν‚¤λ΅ κ³µμ  λΉ„λ°€μΈ ν‚¤λ¥Ό μ λ„ν•΄λ‚Έλ‹¤. OpenSSLμ„ μ‚¬μ©ν•  κ²½μ° int EVP_PKEY_derive(EVP_PKEY_CTX *ctx, unsigned char *key, size_t *keylen)λ¥Ό μ‚¬μ©ν•λ©΄ λκ³ , μ΄λ• μ λ„λ ν‚¤μΈ κ³µμ  λΉ„λ°€μ„ ZλΌκ³  ν•λ‹¤. κ·Έ ν›„ Zλ΅λ¶€ν„° HKDFμ„ μ΄μ©ν•μ—¬ SNI μ•”νΈν™” ν‚¤λ¥Ό μ•„λμ™€ κ°™μ΄ μƒμ„±ν•  μ μλ‹¤.\nZx = HKDF-Extract(0, Z) key = HKDF-Expand-Label(Zx, KeyLabel, Hash(ESNIContents), key_length) iv = HKDF-Expand-Label(Zx, IVLabel, Hash(ESNIContents), iv_length) μ²« Client Helloμ—λ” KeyLabelμ„ β€esni key\"λ΅, IVLabelμ„ β€esni iv\"λ΅ μ„¤μ •ν•λ‹¤. ν΄μ•„μ΄μ–ΈνΈμ λ‘ λ²μ§Έ Client Hello μ¦‰, μ²« λ²μ§Έ Client Helloμ— λ¬Έμ κ°€ μμ–΄μ„ Hello Retry Requestλ¥Ό λ³΄λ‚Έ/λ°›μ€ λ’¤μ—λ” KeyLabelμ„ β€hrr esni key\"λ΅, IVLabelμ„ β€hrr esni iv\"λ΅ μ„¤μ •ν•λ‹¤.\nSNI μ•”νΈν™”ν•κΈ° SNI μ•”νΈν™” ν‚¤ μƒμ„± ν›„ μ•”νΈν™”μ— ν•„μ”ν• κ²ƒμ€ λ‹¤μκ³Ό κ°™λ‹¤.\nRecord Digest: μ•”νΈν™”ν•  λ• μ‚¬μ©ν• ESNIKeysμ ν•΄μ‰¬κ°’ ESNI Key Share: SNI μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•  λ• μ‚¬μ©λ μμ‹ μ κ³µκ°ν‚¤ TLS Key Share: Client Hello β€key_shareβ€ extensionμ— μλ” μμ‹ μ κ³µκ°ν‚¤ cut-and-paste κ³µκ²©μ„ λ°©μ§€ν•κΈ° μ„ν•΄μ„ AADλ΅ μ‚¬μ©ν•λ‹¤. λλ¤: Client Helloμ λλ¤ μ„ μ”μ†κ°€ μ¤€λΉ„λμ—λ‹¤λ©΄ ν΄λΌμ΄μ–ΈνΈλ” μ•”νΈν™”ν•  μ„λ²„ μ΄λ¦„μ— ν¨λ”©μ„ μ μ©ν•κ³  CientESNIInner κ°μ²΄λ¥Ό λ§λ“¤μ–΄μ•Ό ν•λ‹¤. ν¨λ”©μ„ ν• ν›„ κΈΈμ΄κ°€ ESNIKeysμ padded_lengthμ™€ κ°™μ•„μ•Ό ν•λ‹¤.\nstruct { opaque dns_name\u003c1..2^16-1\u003e; opaque zeros[ESNIKeys.padded_length - length(dns_name)]; } PaddedServerNameList; struct { uint8 nonce[16]; PaddedServerNameList realSNI; } ClientESNIInner; nonce: μ„λ²„λ΅λ¶€ν„° λλλ ¤ λ³΄λ‚΄μ§ λλ¤ν• 16 λ°”μ΄νΈ κ°’ dns_name: server_name extensionμ— λ“¤μ–΄κ°€λ” μ„λ²„ μ΄λ¦„ λ©λ΅ zeros: 0μΌλ΅ λ ν¨λ”©. ν¨λ”©μ ν¬κΈ°λ” ESNIKeysμ padded_lengthμ— μν•΄ κ²°μ •λλ‹¤. ClientESNIInnerκ°€ μ¤€λΉ„λμ—λ‹¤λ©΄ μ΄ κ°’μ„ AEAD-Encryptλ΅ μ•”νΈν™”ν•λ©΄ λλ‹¤.\nμμ„Έν• λ‚΄μ©μ€ ESNI μ΄μ• 5.1.1 μ•”νΈν™”λ SNI λ³΄λ‚΄κΈ° μ°Έκ³ \nGitHub sftcd/openssl λ¦¬ν¬μ§€ν† λ¦¬μ— ESNI μ•”νΈν™”/λ³µνΈν™” ν•¨μκ°€ κµ¬ν„λμ–΄ μλ‹¤.\nμ•”νΈν™”λ SNIλ¥Ό λ³µνΈν™”ν•κΈ° SNI μ•”νΈν™”ν•κΈ°μ—μ„ μ•”νΈν™”μ— μ‚¬μ©λ λ¨λ“  λ°μ΄ν„°λ” Client Helloμ— λ“¤μ–΄μλ‹¤. SNI μ•”νΈν™” ν‚¤ μƒμ„± μ΄ν›„ Client Helloμ— μλ” β€encrypted_server_nameβ€ extensionκ³Ό Random, β€key_shareβ€ extensionμ„ κ°€μ Έμ™€μ„ AEAD-Decrypt ν•λ©΄ λ³µνΈν™”κ°€ κ°€λ¥ν•λ‹¤.\nESNIλ¥Ό μ‚¬μ©ν•λ©΄ μ ν•΄μ‚¬μ΄νΈ μ°¨λ‹¨μ΄ μ–΄λ ¤μ΄ μ΄μ  μ°λ¦¬λ‚λΌμ—μ„λ” μ ν•΄μ‚¬μ΄νΈ μ°¨λ‹¨μ„ ν•κ³  μκ³ , μ—¬λ¬ νμ‚¬μ—μ„λ„ λΉ„μ—…λ¬΄μ‚¬μ΄νΈλ¥Ό λ§‰κΈ° μ„ν•΄ λ…Έλ ¥ν•κ³  μλ‹¤. ν•μ§€λ§, ESNIκ°€ λ³Έκ²©μ μΌλ΅ μ μ©λλ©΄ μ§€κΈκΉμ§€ μ μ©ν•κ³  μλ μ°¨λ‹¨ λ°©λ²•λ“¤μ€ μ‚¬μ©ν•κΈ° μ–΄λ ¤μΈ κ²ƒμ΄λ‹¤. μΌλ‹¨ μ°λ¦¬λ‚λΌμ κ²½μ° μ°¨λ‹¨ λ°©μ‹μΌλ΅ μ •κ³µλ²•μ΄ μ•„λ‹ κΌΌμλ¥Ό μ΄μ©ν• μ°¨λ‹¨μ„ ν•μ§„ λ»ν•  κ²ƒμ΄λ‹¤. κΌΌμλ΅ μ°¨λ‹¨μ„ μ§„ν–‰ν•λ‹¤λ©΄ μ–Έμ λ“ μ§€ ν¨μΉλ  κ°€λ¥μ„±μ΄ μκΈ° λ•λ¬Έμ— κ²°κµ­ κ³ λ ¤ν•  μ μλ” λ°©λ²•μ€ μ •κ³µλ²•μΈ ESNI MITMμΈλ° λ³΄λ©΄ μ•κ² μ§€λ§ κµ­κ°€ λ‹¨μ„λ΅ νΉν μ°λ¦¬λ‚λΌμ—μ„ μ μ©ν•κΈ΄ μ–΄λ ¤μ΄ κΈ°μ μ΄λ‹¤.\nνμ‚¬λ“¤μ κ²½μ° SSL κ°€μ‹μ„±μ„ ν™•λ³΄ν•λ” ν•νƒλ΅ λΉ„μ—…λ¬΄μ‚¬μ΄νΈλ¥Ό μ°¨λ‹¨ν•κ³  μμ„ κ²ƒμΈλ°, κ²°κµ­ HTTPS ν†µμ‹ μ— λ¬Έμ κ°€ μ—†κ² ν•κΈ° μ„ν•΄μ„ λ£¨νΈ μΈμ¦μ„λ¥Ό μ„¤μΉν•΄λ‘λ”λΌλ„ SSL κ°€μ‹μ„± ν™•λ³΄ μ¥λΉ„μ—μ„ SNIλ¥Ό ν™•μΈν•λ” ν•νƒλ΅ λ”°λ΅ μ ‘μ†ν•λ” μ‚¬μ΄νΈμ— λ€ν• μΈμ¦μ„λ¥Ό λ°°ν¬ν•κ³  μμ„ κ²ƒμ΄λ‹¤. ν•μ§€λ§, μΈμ¦μ„λ¥Ό λ°°ν¬ν•κΈ°μ„ν•΄ μ°Έκ³ ν•κ³  μλ SNIκ°€ μ•”νΈν™”λμ–΄λ²„λ¦¬λ‹ SSL κ°€μ‹μ„± μ¥λΉ„μ—μ„ ESNI MITM κΈ°λ¥μ„ μ κ³µν•΄μ•Όν•  κ²ƒμ΄λ‹¤.\nESNIκ°€ μ‚¬μ©λ ν†µμ‹ μ„ μ°¨λ‹¨ν•λ” λ°©λ²• DoHλ¥Ό μ°¨λ‹¨ν•λ” λ°©λ²• ν„μ¬κΉμ§€ ESNIλ¥Ό κ³µμ‹μ μΌλ΅ μ§€μ›ν•λ” λΈλΌμ°μ €λ” Firefoxλ°–μ— μ—†λ‹¤. Firefoxλ” DoHλ¥Ό μ‚¬μ©ν•μ§€ μ•μΌλ©΄ ESNIλ¥Ό μ‚¬μ©ν•  μ μ—†κ² λμ–΄μκΈ° λ•λ¬Έμ— DoHλ§ μ°¨λ‹¨ν•΄λ„ μ‰½κ² ESNIλ¥Ό μ°¨λ‹¨ν•  μ μλ‹¤. λ¬Όλ΅ , μ •κ³µλ²•μ΄ μ•„λ‹ κΌΌμμΈλ°λ‹¤ λ‹¤λ¥Έ λΈλΌμ°μ €λ“¤μ΄ ESNIλ¥Ό μ§€μ›ν•κ³  κ·Έ λΈλΌμ°μ €λ“¤ μ¤‘ DoHκ°€ ν•„μ μµμ…μ΄ μ•„λ‹ λΈλΌμ°μ €κ°€ μλ‹¤λ©΄ ν¨κ³Όκ°€ μ—†μ„ κ²ƒμ΄λ‹¤.\nESNIλ¥Ό MITMν•λ” λ°©λ²• μΌλ‹¨, ν΄λΌμ΄μ–ΈνΈκ°€ ESNI λ μ½”λ“λ¥Ό DNS μ„λ²„μ— μ”μ²­ν–μ„ λ• λ‚΄κ°€ λ§λ“  ESNI λ μ½”λ“λ¥Ό μ‘λ‹µν•΄μ•Ό ν•λ‹¤. μ”μ²­ ν¨ν‚·μ€ λ‚΄κ°€ λ¬΄μ΅°κ±΄ DNS μ„λ²„λ³΄λ‹¤ λ¨Όμ € μ‘λ‹µν•΄μ¤„ μ μλ‹¤λ©΄ λ‚λ‘¬λ„ λμ§€λ§ μ•„λ‹λΌλ©΄ λ“λν•λ„λ΅ ν•λ‹¤. λ‚λ¨Έμ§€λ” λ„λ¦¬ μ•λ ¤μ§„ TLS MITMκ³Ό λΉ„μ·ν• λ°©μ‹μΌλ΅ λ™μ‘ν•λ‹¤. ν΄λΌμ΄μ–ΈνΈκ°€ SNIλ¥Ό μ•”νΈν™”ν–λ”λΌλ„ λ‚΄κ°€ μ‘λ‹µν•΄μ¤€ ESNI λ μ½”λ“(ν‚¤)λ¥Ό μ‚¬μ©ν•΄μ„ μ•”νΈν™”ν–κΈ° λ•λ¬Έμ— μ¤‘κ°„μ—μ„ λ³µνΈν™”ν•  μ μλ‹¤. ν•μ§€λ§, κ·Έλ ‡λ‹¤κ³  κ·Έ Client Hello ν¨ν‚·μ„ κ·Έλ€λ΅ μ„λ²„μ—κ² λ³΄λ‚΄μ£Όλ©΄ μ„λ²„λ” SNIλ¥Ό λ³µνΈν™”ν•  μ μ—†κΈ° λ•λ¬Έμ— ν”„λ΅μ‹ λλ‚μΌλ΅ μ„λ²„λ΅ λ³„λ„λ΅ μ”μ²­ν•κ³  μ‘λ‹µμ„ λ°›μ•„μ™€μ•Όν•λ‹¤. κ·Έ ν›„ μ„λ²„λ΅λ¶€ν„° λ°›μ€ μ‘λ‹µμ„ κ·Έλ€λ΅ ν΄λΌμ΄μ–ΈνΈμ—κ² μ „λ‹¬ν•΄μ£Όλ©΄ λλ‹¤. λ³„λ„λ΅ μ„λ²„λ΅ μ”μ²­ν•  λ•λ” κµ³μ΄ ESNIλ¥Ό μ‚¬μ©ν•μ§€ μ•μ•„λ„ λλ‹¤. ESNI MITMμ΄ μ •μƒμ μΌλ΅ λ™μ‘ν•κΈ° μ„ν•΄μ„  μ–΄λ–¤ ν΄λΌμ΄μ–ΈνΈ(IP, Port)κ°€ μ–΄λ””λ΅ μ ‘μ†ν–λ”μ§€λ¥Ό λ¨λ‘ λ¶„μ„ν•΄μ„ κΈ°μ–µν•κ³  μμ–΄μ•Ό ν•λ‹¤.\nESNI MITMμ€ μ •κ³µλ²•μ΄κΈ° λ•λ¬Έμ— ESNIλ¥Ό μ‚¬μ©ν•λ”ν• μ°νν•  μ μ—†λ‹¤. ν•μ§€λ§, μ†κ·λ¨ λ„¤νΈμ›ν¬μ—λ” μ μ©ν•κΈ° μ‰½μ§€λ§, λ€κ·λ¨ λ„¤νΈμ›ν¬μ—λ” μ»΄ν“¨ν„° μμ› λ¬Έμ , λ¨λ“  λ„¤νΈμ›ν¬ νΈλν”½μ„ λ¶„μ„ν•΄μ•Ό λλ‹¤λ” λ¬Έμ  λ•λ¬Έμ— μ μ©ν•κΈ° μ–΄λ µλ‹¤. λ¬Όλ΅  ISPλ” λ§μλ§ λ¨ΉμΌλ©΄ λ¨λ“  λ„¤νΈμ›ν¬ νΈλν”½μ„ ν™•μΈν•  μ μμ§€λ§, λ¬΄μ—‡λ³΄λ‹¤ MITMμ€ μ—„μ—°ν ν•΄ν‚Ήμ΄κΈ° λ•λ¬Έμ— λ²•μ μΌλ΅λ„ μ ν•΄μ‚¬μ΄νΈ μ°¨λ‹¨ λ°©λ²•μΌλ΅λ” μ‚¬μ©ν•  μ μ—†μ„ κ²ƒμ΄λ‹¤. λ¨λ“  κ²ƒμ„ κ°μν•λ”λΌλ„ QoS λ•λ¬Έμ— ISPμ—μ„λ” μ λ€ λ¬Έμ κ°€ μƒκΈΈ μ μλ” In-Path λ°©μ‹μ μ†”λ£¨μ…μ€ μ μ©ν•μ§€ λ»ν•  κ²ƒμ΄λ‹¤.\nTLS μΈμ¦μ„λ¥Ό μ΄μ©ν•λ” λ°©λ²• HTTPS ν†µμ‹ μ„ μ°¨λ‹¨ν•λ” λ°©λ²•μ€ SNIλ¥Ό μ΄μ©ν•λ” λ°©λ²• μ™Έμ—λ„ μΈμ¦μ„μ— μλ” Issued Toμ CN ν•„λ“λ¥Ό μ΄μ©ν•λ” λ°©λ²•λ„ μλ‹¤. ν•μ§€λ§, ESNIκ°€ μ‚¬μ©κ°€λ¥ν• TLS 1.3 λ¶€ν„°λ” μΈμ¦μ„λ„ μ•”νΈν™”ν•΄μ„ μ „μ†΅ν•κΈ° λ•λ¬Έμ— μΌλ°μ μΈ λ°©λ²•μΌλ΅λ” μ‚¬μ©μ΄ λ¶κ°€λ¥ν•λ‹¤. ν„μ¬λ” ν¨μΉλμ–΄ μ‚¬μ©ν•  μ μ—†λ” λ°©λ²•μ΄μ§€λ§ μ›λ¦¬λ” λ‹¤μκ³Ό κ°™λ‹¤.\nTLS μΈμ¦μ„λ¥Ό ν‰λ¬ΈμΌλ΅ λ°›μ•„λ³΄κΈ° μ„ν•΄μ„  TLSμ λ²„μ „μ„ λ‹¤μ΄κ·Έλ μ΄λ“ν•΄μ•Ό ν•λ‹¤. TLS ν†µμ‹  μ¤‘ Client Hello ν¨ν‚·μ„ λ³΄λ©΄ supported_versions extensionμ΄ ν¬ν•¨λμ–΄ μλ”λ°, μ΄ λ°μ΄ν„°λ΅ μ‹¤μ  TLS ν†µμ‹ μ λ²„μ „μ΄ κ²°μ •λλ‹¤. supported_versions extensionμ— μλ” λ²„μ „ λ©λ΅μ—μ„ TLS 1.3μ„ μ κ±°ν• ν›„ Client Hello ν¨ν‚·μ„ ESNI μ„λ²„μ— λ³΄λ‚Έλ‹¤λ©΄, ESNI μ„λ²„λ” μ•”νΈν™”λ SNIλ¥Ό λ³µνΈν™”ν•΄μ„ SNIλ¥Ό μ–»μ–΄λ‚Έ ν›„ μ‚¬μ©ν•  μ μλ” λ²„μ „ μ¤‘ κ°€μ¥ λ†’μ€ TLS 1.2λ΅ ν†µμ‹ μ„ μ§„ν–‰ν•λ‹¤. TLS 1.2λ” μΈμ¦μ„λ¥Ό μ•”νΈν™”ν•μ§€ μ•κΈ° λ•λ¬Έμ— μ•μ„ λ§ν• Issued Toμ μ •λ³΄λ¥Ό μ΄μ©ν•΄μ„ μ°¨λ‹¨μ΄ κ°€λ¥ν•λ‹¤.\nμ§μ ‘ ESNI ν¨ν‚·μ„ λ°μƒμ‹ν‚¤μ§€ μ•κ³ λ„ κ°€λ¥ν•λ°, encrypted_sni extensionμ΄ ν¬ν•¨λ ν¨ν‚·μ—μ„ TLS 1.3μ„ μ κ±°ν• ν›„ κ·Έλ€λ΅ μ „μ†΅ν•΄λ„ μ•”νΈν™”λμ§€ μ•μ€ μΈμ¦μ„λ¥Ό λ°›μ•„λ³Ό μ μλ‹¤. νΈλ²•μ΄κΈ° λ•λ¬Έμ— ν¨μΉλμ—μ§€λ§, ν¨μΉλμ§€ μ•μ•λ‹¤λ©΄ HTTPS μ°¨λ‹¨ λ°©λ²•μΌλ΅λ„ μ΄μ©μ΄ κ°€λ¥ν–μ„ κ²ƒμ΄λ‹¤.\n","wordCount":"2057","inLanguage":"ko","datePublished":"2020-03-03T16:11:28+09:00","dateModified":"2020-03-03T16:11:28+09:00","author":{"@type":"Person","name":"Pol4bear"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://pol4.dev/posts/what-is-esni/"},"publisher":{"@type":"Organization","name":"Pol4bear's blog","logo":{"@type":"ImageObject","url":"https://pol4.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://pol4.dev accesskey=h title="Pol4bear's blog (Alt + H)"><img src=https://pol4.dev/apple-touch-icon.png alt aria-label=logo height=35>Pol4bear's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://pol4.dev/categories/ title=π“„μΉ΄ν…κ³ λ¦¬><span>π“„μΉ΄ν…κ³ λ¦¬</span></a></li><li><a href=https://pol4.dev/tags/ title=π”–νƒκ·Έ><span>π”–νƒκ·Έ</span></a></li><li><a href=https://pol4.dev/search/ title="π”κ²€μƒ‰ (Alt + /)" accesskey=/><span>π”κ²€μƒ‰</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://pol4.dev>ν™</a>&nbsp;Β»&nbsp;<a href=https://pol4.dev/posts/>Posts</a></div><h1 class=post-title>μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI</h1><div class=post-description>ESNIμ— λ€ν•΄ μ•μ•„λ³΄μ</div><div class=post-meta><span title='2020-03-03 16:11:28 +0900 KST'>2020λ…„ 3μ›” 3μΌ</span>&nbsp;Β·&nbsp;10 λ¶„&nbsp;Β·&nbsp;2057 λ‹¨μ–΄&nbsp;Β·&nbsp;Pol4bear&nbsp;|&nbsp;<a href=https://github.com/pol4bear/pol4bear.github.io/issues rel="noopener noreferrer" target=_blank>μ¤λ¥ μ λ³΄</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>λ©μ°¨</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#μ„λ΅ >μ„λ΅ </a></li><li><a href=#sniλ€>SNIλ€?</a><ul><li><a href=#server_name-extension>&ldquo;server_name&rdquo; extension</a></li></ul></li><li><a href=#esniλ€>ESNIλ€?</a><ul><li><a href=#esniμ-λ™μ‘-λ°©μ‹>ESNIμ λ™μ‘ λ°©μ‹</a></li><li><a href=#encrypted_server_name-extension>&ldquo;encrypted_server_name&rdquo; extension</a></li></ul></li><li><a href=#esni-μμ„Έν-μ•μ•„λ³΄κΈ°>ESNI μμ„Έν μ•μ•„λ³΄κΈ°</a><ul><li><a href=#esni-λ μ½”λ“>ESNI λ μ½”λ“</a></li><li><a href=#esni-λ μ½”λ“μ—μ„-μ •λ³΄-μ·¨λ“ν•κΈ°>ESNI λ μ½”λ“μ—μ„ μ •λ³΄ μ·¨λ“ν•κΈ°</a></li><li><a href=#sni-μ•”νΈν™”-ν‚¤-μƒμ„±>SNI μ•”νΈν™” ν‚¤ μƒμ„±</a></li><li><a href=#sni-μ•”νΈν™”ν•κΈ°>SNI μ•”νΈν™”ν•κΈ°</a></li><li><a href=#μ•”νΈν™”λ-sniλ¥Ό-λ³µνΈν™”ν•κΈ°>μ•”νΈν™”λ SNIλ¥Ό λ³µνΈν™”ν•κΈ°</a></li></ul></li><li><a href=#esniλ¥Ό-μ‚¬μ©ν•λ©΄-μ ν•΄μ‚¬μ΄νΈ-μ°¨λ‹¨μ΄-μ–΄λ ¤μ΄-μ΄μ >ESNIλ¥Ό μ‚¬μ©ν•λ©΄ μ ν•΄μ‚¬μ΄νΈ μ°¨λ‹¨μ΄ μ–΄λ ¤μ΄ μ΄μ </a></li><li><a href=#esniκ°€-μ‚¬μ©λ-ν†µμ‹ μ„-μ°¨λ‹¨ν•λ”-λ°©λ²•>ESNIκ°€ μ‚¬μ©λ ν†µμ‹ μ„ μ°¨λ‹¨ν•λ” λ°©λ²•</a><ul><li><a href=#dohλ¥Ό-μ°¨λ‹¨ν•λ”-λ°©λ²•>DoHλ¥Ό μ°¨λ‹¨ν•λ” λ°©λ²•</a></li><li><a href=#esniλ¥Ό-mitmν•λ”-λ°©λ²•>ESNIλ¥Ό MITMν•λ” λ°©λ²•</a></li><li><a href=#tls-μΈμ¦μ„λ¥Ό-μ΄μ©ν•λ”-λ°©λ²•>TLS μΈμ¦μ„λ¥Ό μ΄μ©ν•λ” λ°©λ²•</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=μ„λ΅ >μ„λ΅ <a hidden class=anchor aria-hidden=true href=#μ„λ΅ >#</a></h2><p>2019λ…„ 3μ›” μ°λ¦¬λ‚λΌμ—μ„ SNI κΈ°λ°μ μ ν•΄μ‚¬μ΄νΈ λ°©μ‹μ΄ μ μ©λκ³ λ‚μ„ GoodbyeDPI, μ¤λ‚μ΄νΌ, μ λ‹μ½ λ“±κ³Ό λ”λ¶μ–΄ ESNIκ°€ μƒλ΅μ΄ μ ν•΄μ‚¬μ΄νΈ μ°¨λ‹¨ μ°ν λ°©μ‹μΌλ΅ μ‚¬μ©λκ³  μλ‹¤. μ•„λ¬΄λ¦¬ ESNIκ°€ κ°μΈμ •λ³΄ μΉ¨ν•΄λ¥Ό λ§‰μ•„μ¤€λ‹¤κ³  ν•μ§€λ§ μΈν„°λ„· κ²€μ—΄μ„ ν•μ§€ μ•λ” λ‚λΌλ“¤μ€ ν•„μ”λ΅ ν•μ§€ μ•μ„ κ²ƒμ΄κ³ , κ²€μ—΄μ„ ν•λ” λ‚λΌλ“¤μ€ μ°λ¦¬λ‚λΌμ™€λ” λΉ„κµν•μ§€ λ»ν•  λ§νΌ λ” μ„Έκ² κ²€μ—΄ν•κΈ° λ•λ¬Έμ— μ°λ¦¬λ‚λΌλ¥Ό μ μ™Έν• λ‹¤λ¥Έ λ‚λΌλ“¤μ—μ„λ” κ·Έλ‹¤μ§€ λ§¤λ ¥μλ” κΈ°μ μ΄ μ•„λ‹ κ²ƒ κ°™λ‹¤.</p><p>ESNIλ” ν”„λΌμ΄λ²„μ‹μ μΌλ΅ μ •λ§ μΆ‹μ€ κΈ°μ μΈ κ²ƒ κ°™λ‹¤. λν• SNI μ°¨λ‹¨ μ¥λΉ„λ“¤μ΄ μ—…λ°μ΄νΈλμ–΄ μ°νν•  μ μλ” λ°©λ²•μ΄ ESNIμ™€ VPNμ΄λ‚ ν”„λ΅μ‹λ°–μ— λ‚¨μ§€ μ•λ”λ‹¤λ©΄ νΉν μ°λ¦¬λ‚λΌ μ‚¬λλ“¤μ—κ²λ” μ‚¬λ‘λ°›λ” κΈ°μ μ΄ λ  κ²ƒμ΄λ‹¤. ESNIκ°€ ν‘μ¤€μΌλ΅ λ°μ „ν•κ³  κ³µμ‹μ μΌλ΅ μ‚¬μ©λκΈ° μ‹μ‘ν•λ‹¤λ©΄ μ•”νΈν™”λ λ‚΄μ©μ„ λ³µνΈν™”ν•΄λ³Ό μ μ—†λ” μ°λ¦¬λ‚λΌμ—μ„λ” μ ν•΄μ‚¬μ΄νΈλ¥Ό μ°¨λ‹¨ν•κΈ° μ–΄λ ¤μΈ(λ¶κ°€λ¥ν•λ‹¤κ³ λ” ν•μ§€ μ•κ² λ‹¤) κ²ƒμ΄λ‹¤. μ•„λ§ μ΅°λ§κ°„ λΉλ²ν•κ² μ‚¬μ©λ  ESNIλ€ κΈ°μ μ— λ€ν•΄μ„ ν•λ² μ•μ•„λ³΄μ.</p><h2 id=sniλ€>SNIλ€?<a hidden class=anchor aria-hidden=true href=#sniλ€>#</a></h2><p>ESNIμ— λ€ν•΄ μ•μ•„λ³΄κΈ° μ „μ— SNIλ¥Ό λ¨Όμ € μ•μ•„μ•Ό ν•λ‹¤. HTTPSκ°€ ν†µμ‹ μ—μ„ ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„μ™€ ν†µμ‹  μ „μ— μ–΄λ–¤ λ°©μ‹μΌλ΅ μ•”νΈν™”ν• μ§€, μ–΄λ–¤ λ°©μ‹μΌλ΅ ν‚¤λ¥Ό κµν™ν• μ§€, μ–΄λ–¤ SSL/TLS λ²„μ „μ„ μ‚¬μ©ν• μ§€ μ •ν•κΈ° μ„ν•΄ Handshake ν†µμ‹ μ„ μ§„ν–‰ν•λ‹¤.</p><p><img loading=lazy src=tls-handshake.png alt title="TLS Handshake"></p><p>Handshake κ³Όμ •μ—μ„ ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„μ μΈμ¦μ„λ¥Ό μ „μ†΅λ°›κ² λλ”λ° κ·Έ μΈμ¦μ„λ΅ μμ‹ μ΄ λ§λ” μ„λ²„λ΅ μ ‘μ†ν•λ” κ²ƒμΈμ§€ κ²€μ¦ν•κ² λλ‹¤. μ„λ²„λ” ν΄λΌμ΄μ–ΈνΈμ—κ² μ μ ν• μΈμ¦μ„λ¥Ό μ „μ†΅ν•΄μ¤μ•Ό ν•λ‹¤. μλ¥Ό λ“¤μ–΄ ν•λ‚μ μ„λ²„μ—μ„ νμ΄μ¤λ¶κ³Ό νΈμ„ν„° λ‘ κ°μ μ„λΉ„μ¤λ¥Ό μ κ³µν•λ‹¤κ³  μƒκ°ν•΄λ³΄μ. ν΄λΌμ΄μ–ΈνΈκ°€ μ—°κ²°ν•  λ• μ–΄λ””μ— μ ‘μ†ν•λ”μ§€ ν‘μ‹λ¥Ό ν•΄λ‘μ§€ μ•λ”λ‹¤λ©΄ μ„λ²„λ” νμ΄μ¤λ¶, νΈμ„ν„° λ‘ μ¤‘ μ–΄λ–¤ μΈμ¦μ„λ¥Ό μ „μ†΅ν•  μ§€ κ²½μ •ν•  μ μ—†μ„ κ²ƒμ΄λ‹¤. μ΄ λ¬Έμ λ¥Ό ν•΄κ²°ν•κΈ° μ„ν•΄ TLS extensionμΈ <a href=https://tools.ietf.org/html/rfc3546#section-3.1>SNI(Server Name Indication)</a>κ°€ RFC 3546μ—μ„ λ“±μ¥ν–λ‹¤.</p><h3 id=server_name-extension>&ldquo;server_name&rdquo; extension<a hidden class=anchor aria-hidden=true href=#server_name-extension>#</a></h3><p>&ldquo;server_name&rdquo; extensionμ Typeμ€ 00 00μ΄λ‹¤. μ²« 4λ°”μ΄νΈ Typeκ³Ό μ „μ²΄ κΈΈμ΄λ” λ¨λ“  TLS extensionμ΄ κ³µν†µμ μΌλ΅ κ°€μ§„ ν•„λ“λ‹¤.</p><p><img loading=lazy src=sni-example.png alt title="SNI example"></p><h2 id=esniλ€>ESNIλ€?<a hidden class=anchor aria-hidden=true href=#esniλ€>#</a></h2><p>SNIκ°€ μ‚¬μ©λκΈ° μ‹μ‘ν•λ©΄μ„ μ„λ²„ λΏλ§μ΄ μ•„λ‹λΌ μ  3μλ„ ν΄λΌμ΄μ–ΈνΈκ°€ μ–΄λ””μ— μ ‘μ†ν•λ ¤λ”μ§€ μ‰½κ² μ•μ•„λ‚Ό μ μλ‹¤λ” λ‹¨μ μ΄ μƒκ²Όλ‹¤. ν†µμ‹ λλ” λ‚΄μ© μμ²΄λ” μ•”νΈν™”λμ–΄ μ• μ μ—†λ‹¤κ³  ν•λ”λΌλ„ &ldquo;μ–΄λ–¤ IP μ£Όμ†λ¥Ό κ°€μ§„ μ‚¬λμ΄ μ–΄λ–¤ μ‚¬μ΄νΈμ— λΉλ²ν•κ² μ ‘μ†ν•λ”λΌ&rdquo; μ΄λ° μ‹μΌλ΅ ν΄λΌμ΄μ–ΈνΈκ°€ μ–΄λ””μ— μ ‘μ†ν•λ”κ°€λ§ μμ§‘ν•λ”λΌλ„ μ¶©λ¶„ν κ°μΈμ •λ³΄ μΉ¨ν•΄κ°€ λ  μ μλ‹¤. μ‹¤μ λ΅ μ°λ¦¬λ‚λΌλ” 2019λ…„ 3μ›”κ²½ HTTP Host ν•„λ“λ¥Ό λ³΄κ³  μ ν•΄μ‚¬μ΄νΈλ¥Ό μ°¨λ‹¨ν•΄μ„ HTTPSλ” μ°¨λ‹¨ν•  μ μ—†μ—λ μƒν™©μ—μ„ SNI λ¥Ό μ κ·Ήμ μΌλ΅ μ΄μ©ν• SNI μ°¨λ‹¨λ°©μ‹μ„ μ‚¬μ©ν•μ—¬ HTTPS ν†µμ‹  λν• μ°¨λ‹¨ν•κ³  μλ‹¤. μ™Έκµ­μ—μ„λ„ μ΄λ° κ°μΈμ •λ³΄ μΉ¨ν•΄ κ΄€λ ¨ν•΄μ„ λ¬Έμ κ°€ μμ—λ”μ§€ μ΄ SNI μ •λ³΄λ¥Ό μ•”νΈν™”ν•  μ μλ” <a href=https://tools.ietf.org/html/draft-ietf-tls-esni>ESNI Extension</a>μ΄ λ“±μ¥ν–λ‹¤.</p><p>Encrypted Server Name Indication μ¦‰, ESNIλ” μ•„μ§ TLS 1.3μ ν‘μ¤€μ΄ μ•„λ‹ draftμΈ μƒνƒλ‹¤. λ€λ¶€λ¶„μ SSL/TLS λΌμ΄λΈλ¬λ¦¬κ°€ μ•„μ§ ESNIλ¥Ό μ§€μ›ν•κ³  μμ§€ μ•μ§€λ§, Mozillaμ <a href=https://www.mozilla.org/ko/firefox/new/>Firefox λΈλΌμ°μ €</a>λ¥Ό μ΄μ©ν•λ©΄ ESNIλ¥Ό μ‚¬μ©ν•  μ μλ‹¤. μ„λ²„μ κ²½μ° <a href=https://www.cloudflare.com/>Cloudflare</a>μ ν”„λ΅μ‹λ¥Ό μ‚¬μ©ν•λ©΄ μ μ©μ΄ κ°€λ¥ν•λ‹¤.</p><p>ESNIμ ν•µμ‹¬μ μΈ λ‚΄μ©μ€ TLS ν†µμ‹ μ΄ μ΄λ£¨μ–΄μ§€κΈ° μ „ μ–΄λ–»κ² ν‚¤λ¥Ό κµν™ν•  κ²ƒμΈμ§€λ‹¤. κ²°κµ­ SNIλ¥Ό μ•”νΈν™”ν•λ ¤λ©΄ μ•”νΈν™” ν‚¤κ°€ ν•„μ”ν•λ° ESNIλ” μ΄ ν‚¤ κ΄€λ ¨ λ¬Έμ λ¥Ό TLS ν†µμ‹  μ „ DNS μ„λ²„μ—μ„ λ°›μ•„μ¤λ” λ°©μ‹μΌλ΅ μ΄ λ¬Έμ λ¥Ό ν•΄κ²°ν–λ‹¤. ESNIμ λ™μ‘ λ°©μ‹μ€ λ‹¤μκ³Ό κ°™λ‹¤.</p><h3 id=esniμ-λ™μ‘-λ°©μ‹>ESNIμ λ™μ‘ λ°©μ‹<a hidden class=anchor aria-hidden=true href=#esniμ-λ™μ‘-λ°©μ‹>#</a></h3><p><img loading=lazy src=esni.png alt title=ESNI></p><h4 id=1-μ„λ²„---esni-λ μ½”λ“esni-λ μ½”λ“-dns-μ„λ²„μ—-λ³΄κ΄€ν•κΈ°>1. μ„λ²„ - <a href=#esni-%EB%A0%88%EC%BD%94%EB%93%9C>ESNI λ μ½”λ“</a> DNS μ„λ²„μ— λ³΄κ΄€ν•κΈ°<a hidden class=anchor aria-hidden=true href=#1-μ„λ²„---esni-λ μ½”λ“esni-λ μ½”λ“-dns-μ„λ²„μ—-λ³΄κ΄€ν•κΈ°>#</a></h4><p>ESNIλ¥Ό μ κ³µν•  μ„λ²„λ” ESNI λ μ½”λ“ μƒμ„±μ— μ•μ„ <a href=#sni-%EC%95%94%ED%98%B8%ED%99%94-%ED%82%A4-%EC%83%9D%EC%84%B1>SNI μ•”νΈν™” ν‚¤ μƒμ„±</a>μ— μ‚¬μ©λ  μμ‹ μ ν‚¤ μμ„ μƒμ„±ν•λ‹¤. κ·Έλ¦¬κ³ , μ•μ„ μƒμ„±ν• μμ‹ μ ν‚¤ μ μ¤‘ κ³µκ° ν‚¤μ™€ ESNI λ²„μ „, Cipher Suite, μ ν¨κΈ°κ°„ λ“± SNIλ¥Ό μ•”νΈν™”ν•  λ• ν•„μ”ν• μ •λ³΄λ“¤μ΄ ν¬ν•¨λ ESNI λ μ½”λ“λ¥Ό μƒμ„±ν• ν›„ Base 64λ΅ μΈμ½”λ”©ν•΄μ„ DNS μ„λ²„μ— λ³΄κ΄€ν•λ‹¤. λ‹¨, ESNI λ μ½”λ“λ” _esni.[νΈμ¤νΈ μ΄λ¦„]μ— TXT λ μ½”λ“λ΅ λ³΄κ΄€ν•΄μ•Ό ν•λ‹¤.</p><pre tabindex=0><code>_esni.pol4.dev. IN TXT /wEvzh0pACQAHQAgMU5QtkenanuH/Oq2R5sZGt1O8zzZWhUBqala5sduaUIAAhMBAQQAAAAAXlkO0AAAAABeYPfQAAA=
</code></pre><h4 id=2-ν΄λΌμ΄μ–ΈνΈ---dns-μ„λ²„μ—μ„-esni-λ μ½”λ“-κ°€μ Έμ¤κΈ°>2. ν΄λΌμ΄μ–ΈνΈ - DNS μ„λ²„μ—μ„ ESNI λ μ½”λ“ κ°€μ Έμ¤κΈ°<a hidden class=anchor aria-hidden=true href=#2-ν΄λΌμ΄μ–ΈνΈ---dns-μ„λ²„μ—μ„-esni-λ μ½”λ“-κ°€μ Έμ¤κΈ°>#</a></h4><p>ν΄λΌμ΄μ–ΈνΈλ” SNI μ•”νΈν™”μ— μ•μ„ DNS μ„λ²„μ— λ³΄κ΄€λμ–΄ μλ” ESNI λ μ½”λ“λ¥Ό κ°€μ Έμ™€μ•Ό ν•λ‹¤. μ„λ²„μ IPλ¥Ό μ–»μ–΄μ¤λ” DNSμ§μμ™€λ” λ³„κ°λ΅ TXT λ μ½”λ“λ΅ μ €μ¥λμ–΄ μλ” ESNI λ μ½”λ“λ¥Ό κ°€μ Έμ™€μ„ ESNI λ²„μ „κ³Ό ESNI λ μ½”λ“κ°€ λ§λ£λμ§€λ” μ•μ•λ”μ§€ ν™•μΈν•κ³ , SNI μ•”νΈν™” ν‚¤ μƒμ„±μ— μ‚¬μ©λλ” μ„λ²„μ κ³µκ° ν‚¤λ¥Ό μ–»μ–΄λ‚Έλ‹¤.</p><h4 id=3-ν΄λΌμ΄μ–ΈνΈ---esniλ¥Ό-ν¬ν•¨ν•-client-hello-μ „μ†΅ν•κΈ°>3. ν΄λΌμ΄μ–ΈνΈ - ESNIλ¥Ό ν¬ν•¨ν• Client Hello μ „μ†΅ν•κΈ°<a hidden class=anchor aria-hidden=true href=#3-ν΄λΌμ΄μ–ΈνΈ---esniλ¥Ό-ν¬ν•¨ν•-client-hello-μ „μ†΅ν•κΈ°>#</a></h4><p>ν΄λΌμ΄μ–ΈνΈλ” DNS μ„λ²„μ—μ„ κ°€μ Έμ¨ ESNI λ μ½”λ“μ μ„λ²„ κ³µκ° ν‚¤μ™€ κ³µμ  λΉ„λ°€μ„ μ‚¬μ©ν•κΈ° μ„ν• μ„μ‹ ν‚¤ μμ„ μƒμ„±ν•λ‹¤. μƒμ„±ν• μ„μ‹ ν‚¤μ™€ μ„λ²„ κ³µκ° ν‚¤λ¥Ό μ΄μ©ν•΄ μƒμ„±ν• κ³µμ  λΉ„λ°€λ΅ SNI μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•΄μ„ <a href=#sni-%EC%95%94%ED%98%B8%ED%99%94%ED%95%98%EA%B8%B0>SNIλ¥Ό μ•”νΈν™”</a>ν•λ‹¤. μ•”νΈν™”λ SNIλ” Client Helloμ <a href=#encrypted_server_name-extension>&ldquo;encrypted_server_name&rdquo; extension</a>μ— ν¬ν•¨μ‹μΌ μ„λ²„μ— μ „μ†΅ν•λ‹¤.</p><h4 id=4-μ„λ²„---μ•”νΈν™”λ-sni-λ³µνΈν™”μ•”νΈν™”λ-sniλ¥Ό-λ³µνΈν™”ν•κΈ°ν•κ³ -server-hello-μ „μ†΅ν•κΈ°>4. μ„λ²„ - <a href=#%EC%95%94%ED%98%B8%ED%99%94%EB%90%9C-sni%EB%A5%BC-%EB%B3%B5%ED%98%B8%ED%99%94%ED%95%98%EA%B8%B0>μ•”νΈν™”λ SNI λ³µνΈν™”</a>ν•κ³  Server Hello μ „μ†΅ν•κΈ°<a hidden class=anchor aria-hidden=true href=#4-μ„λ²„---μ•”νΈν™”λ-sni-λ³µνΈν™”μ•”νΈν™”λ-sniλ¥Ό-λ³µνΈν™”ν•κΈ°ν•κ³ -server-hello-μ „μ†΅ν•κΈ°>#</a></h4><p>μ„λ²„λ” Client Helloμ &ldquo;encrypted_server_name&rdquo; extensionμ— μλ” ν΄λΌμ΄μ–ΈνΈ μ„μ‹ κ³µκ° ν‚¤μ™€ ESNI κ°μΈ ν‚¤(ESNI λ μ½”λ“μ μ„λ²„ κ³µκ° ν‚¤μ™€ μ)λ¥Ό μ΄μ©ν•μ—¬ SNI μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•λ‹¤. μƒμ„±ν• μ•”νΈν™” ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ <a href=#%EC%95%94%ED%98%B8%ED%99%94%EB%90%9C-sni%EB%A5%BC-%EB%B3%B5%ED%98%B8%ED%99%94%ED%95%98%EA%B8%B0>μ•”νΈν™”λ SNIλ¥Ό λ³µνΈν™”</a>ν• λ’¤ κ·Έμ— λ§λ” Server Helloλ¥Ό ν΄λΌμ΄μ–ΈνΈμ—κ² μ „μ†΅ν•λ‹¤.</p><h3 id=encrypted_server_name-extension>&ldquo;encrypted_server_name&rdquo; extension<a hidden class=anchor aria-hidden=true href=#encrypted_server_name-extension>#</a></h3><p>μ„μ™€ κ°™μ€ κ³Όμ •μ„ κ±°μΉλ©΄ Client Helloμ— &ldquo;encrypted_server_name&rdquo; extensionμ„ μ‚¬μ©ν•  μ μκ² λλ‹¤. <a href=https://tools.ietf.org/html/draft-ietf-tls-esni-05#section-5>ESNI μ΄μ• 5. The &ldquo;encrypted_server_name&rdquo; extension</a>μ— λ”°λ¥΄λ©΄ TLS extension Type ff ceμΈ &ldquo;encrypted_server_name&rdquo; extensionμ κµ¬μ΅°λ” λ‹¤μκ³Ό κ°™λ‹¤.</p><pre tabindex=0><code>struct {
    CipherSuite suite;
    KeyShareEntry key_share;
    opaque record_digest&lt;0..2^16-1&gt;;
    opaque encrypted_sni&lt;0..2^16-1&gt;;
} ClientEncryptedSNI;
</code></pre><ul><li>CipherSuite suite: μ•”νΈν™”μ— μ‚¬μ©λ Cipher Suite</li><li>KeyShareEntry key_share: SNI μ•”νΈν™” ν‚¤ μƒμ„±μ— μ‚¬μ©λ Key Share</li><li>opaque record_digest: SNI ν‚¤ μƒμ„±μ— μ‚¬μ©ν• ESNIKeysμ ν•΄μ‰¬κ°’<ul><li>ν•΄μ‰¬ μ•κ³ λ¦¬μ¦μ€ Cipher Suiteμ— ν¬ν•¨λμ–΄ μλ‹¤.</li></ul></li><li>opaque encrypted_sni: μ•”νΈν™”λ SNI</li></ul><p>μ‹¤μ  ESNIλ¥Ό μ‚¬μ©ν–μ„ λ• &ldquo;encrypted_server_name&rdquo; extensionμ€ λ‹¤μκ³Ό κ°™λ‹¤.</p><p><img loading=lazy src=esni-example.png alt title="ESNI example"></p><h2 id=esni-μμ„Έν-μ•μ•„λ³΄κΈ°>ESNI μμ„Έν μ•μ•„λ³΄κΈ°<a hidden class=anchor aria-hidden=true href=#esni-μμ„Έν-μ•μ•„λ³΄κΈ°>#</a></h2><h3 id=esni-λ μ½”λ“>ESNI λ μ½”λ“<a hidden class=anchor aria-hidden=true href=#esni-λ μ½”λ“>#</a></h3><p><a href=https://tools.ietf.org/html/draft-ietf-tls-esni-04#section-4.1>ESNI μ΄μ• 4.1 μ•”νΈν™”λ SNI λ μ½”λ“</a>μ— λ”°λ¥΄λ©΄ ESNI λ μ½”λ“μ κµ¬μ΅°λ” λ‹¤μκ³Ό κ°™λ‹¤.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Copied from TLS 1.3
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>NamedGroup</span> <span class=n>group</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>opaque</span> <span class=n>key_exchange</span><span class=o>&lt;</span><span class=mf>1..2</span><span class=o>^</span><span class=mi>16</span><span class=o>-</span><span class=mi>1</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>KeyShareEntry</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>uint16</span> <span class=n>version</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>opaque</span> <span class=n>public_name</span><span class=o>&lt;</span><span class=mf>1..2</span><span class=o>^</span><span class=mi>16</span><span class=o>-</span><span class=mi>1</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>KeyShareEntry</span> <span class=n>keys</span><span class=o>&lt;</span><span class=mf>4..2</span><span class=o>^</span><span class=mi>16</span><span class=o>-</span><span class=mi>1</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>CipherSuite</span> <span class=n>cipher_suites</span><span class=o>&lt;</span><span class=mf>2..2</span><span class=o>^</span><span class=mi>16</span><span class=o>-</span><span class=mi>2</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>uint16</span> <span class=n>padded_length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>Extension</span> <span class=n>extensions</span><span class=o>&lt;</span><span class=mf>0..2</span><span class=o>^</span><span class=mi>16</span><span class=o>-</span><span class=mi>1</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>ESNIKeys</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>ESNIKeys</span> <span class=n>esni_keys</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>Extension</span> <span class=n>dns_extensions</span><span class=o>&lt;</span><span class=mf>0..2</span><span class=o>^</span><span class=mi>16</span><span class=o>-</span><span class=mi>1</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>ESNIRecord</span><span class=p>;</span>
</span></span></code></pre></div><h4 id=keyshareentry-κµ¬μ΅°>KeyShareEntry κµ¬μ΅°<a hidden class=anchor aria-hidden=true href=#keyshareentry-κµ¬μ΅°>#</a></h4><h4 id=esnikeys-κµ¬μ΅°μ²΄>ESNIKeys κµ¬μ΅°μ²΄<a hidden class=anchor aria-hidden=true href=#esnikeys-κµ¬μ΅°μ²΄>#</a></h4><p>SNIλ¥Ό μ•”νΈν™”ν•λ”λ° μ‹¤μ  μ‚¬μ©λλ” ν‚¤μ™€ μΌλ¶€ λ©”νƒ€λ°μ΄ν„°λ¥Ό ν¬ν•¨ν•λ‹¤.</p><ul><li><p>uint16 version: μ ‘μ†μ— μ‚¬μ©ν•΄μ•Όν•λ” ESNI λ²„μ „</p></li><li><p>opaque public_name: μ•”νΈν™” ν‚¤λ¥Ό κ°±μ‹ ν•κΈ° μ„ν•΄ μ‚¬μ©λλ” μ‹ λΆ°ν•  μ μλ” κ°μ²΄μ μ΄λ¦„</p><ul><li>μλ»λ μ„¤μ •μ„ λλλ¦΄ λ• μ“°μΈλ‹¤.</li></ul></li><li><p>KeyShareEntry keys: ESNI μ—°κ²°μ— μ‚¬μ©ν•  μ μλ” μ„λ²„ κ³µκ° ν‚¤ λ©λ΅</p><ul><li>κ° ν‚¤λ“¤μ€ λ‹¤λ¥Έ <a href=https://tools.ietf.org/html/rfc8446#section-4.2.7>κ·Έλ£Ή</a>μ„ κ°€μ§€κ³  μμ–΄μ•Όν•λ‹¤.</li></ul></li><li><p>CipherSuite cipher_suites: SNI μ•”νΈν™”μ— μ‚¬μ©ν•  μ μλ” <a href=https://tools.ietf.org/html/rfc8446#appendix-B.4>Cipher Suite</a> λ©λ΅</p></li><li><p>uint16 padded_length: SNIλ¥Ό μ•”νΈν™”ν•κΈ° μ „ ν¨λ”©ν• μ„λ²„ μ΄λ¦„ λ©λ΅μ ν¬κΈ°</p><ul><li>μ„λ²„κ°€ μ§€μ›ν•  κ²ƒμΌλ΅ μμƒλλ” κ°€μ¥ ν° μ„λ²„ μ΄λ¦„ λ©λ΅μ„ 16μ λ°°μμ™€ κ°€κΉκ² λ°μ¬λ¦Όν• ν¬κΈ°μ™€ κ°™κ² μ„¤μ •ν•΄μ•Όν•λ‹¤.</li><li>λ§μ•½ μ„λ²„κ°€ μ„μμ μ™€μΌλ“μΉ΄λ“ μ„λ²„ μ΄λ¦„λ“¤μ„ μ§€μ›ν•λ‹¤λ©΄ 260μΌλ΅ μ„¤μ •ν•΄μ•Όν•λ‹¤.</li><li>ν΄λΌμ΄μ–ΈνΈλ” padded_lengthκ°€ 260λ³΄λ‹¤ ν΄ κ²½μ° ESNIKeysλ¥Ό λ¬΄μ‹ν•΄μ•Όν•λ‹¤.</li><li>ν¨λ”©μ„ ν•μ—¬ μ„λ²„ μ΄λ¦„ λ©λ΅μ κΈΈμ΄λ¥Ό κ³ μ •μ‹ν‚¤λ” μ΄μ λ” κ³µκ²©μκ°€ μ•”νΈν™”λ μ„λ²„ μ΄λ¦„ λ©λ΅μ κΈΈμ΄λ΅ μ„λ²„ μ΄λ¦„μ„ μμΈ΅ν•  μ μ—†κ² λ§λ“¤κΈ° μ„ν•΄μ„λ‹¤.</li></ul></li><li><p>Extension extensions: ν΄λΌμ΄μ–ΈνΈκ°€ Client Helloλ¥Ό λ§λ“λ”λ° μ‚¬μ©ν•  μ μλ” <a href=https://tools.ietf.org/html/rfc8446#section-4.2>TLS extension</a>μ λ©λ΅</p><ul><li>ν–¥ν›„ μ¶”κ°€μ μΈ κΈ°λ¥μ„ μ κ³µν•κΈ° μ„ν• κ³µκ°„μΌλ΅ μ‚¬μ©ν•λ‹¤.</li><li>extensionμ€ Typeμ MSBλ¥Ό 1λ΅ μ„¤μ •ν•¨μΌλ΅μ¨ Client Hello ν•„μμ μΌλ΅ ν¬ν•¨μ‹ν‚¤κ² ν•  μ μλ‹¤.</li><li>ν΄λΌμ΄μ–ΈνΈλ” ν•„μ extensionμΌλ΅ μ„¤μ •λ extension μ¤‘ extensionμ΄ μμΌλ©΄ ν•΄λ‹Ή ESNIKeysλ¥Ό λ¬΄μ‹ν•΄μ•Όν•λ‹¤.</li></ul></li></ul><h4 id=esnirecord-κµ¬μ΅°μ²΄>ESNIRecord κµ¬μ΅°μ²΄<a hidden class=anchor aria-hidden=true href=#esnirecord-κµ¬μ΅°μ²΄>#</a></h4><ul><li>ESNIKeys esni_keys: SNIλ¥Ό μ•”νΈν™”ν•λ”λ° μ‹¤μ  μ‚¬μ©λλ” ν‚¤μ™€ κ·Έ ν‚¤μ™€ κ΄€κ³„λ μ—¬λ¬ λ©”νƒ€λ°μ΄ν„°λ“¤</li><li>Extension extensions: ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„μ DNS μ΄λ¦„μ„ μ§μν• λ• μ°Έκ³ ν•  μ μλ” <a href=https://tools.ietf.org/html/rfc8446#section-4.2>TLS extension</a>μ λ©λ΅<ul><li>ν–¥ν›„ μ¶”κ°€μ μΈ κΈ°λ¥μ„ μ κ³µν•κΈ° μ„ν• κ³µκ°„μΌλ΅ μ‚¬μ©ν•λ‹¤.</li><li>extensionμ€ Typeμ MSBλ¥Ό 1λ΅ μ„¤μ •ν•¨μΌλ΅μ¨ Client Hello ν•„μμ μΌλ΅ ν¬ν•¨μ‹ν‚¤κ² ν•  μ μλ‹¤.</li><li>ν΄λΌμ΄μ–ΈνΈλ” ν•„μ extensionμΌλ΅ μ„¤μ •λ extension μ¤‘ extensionμ΄ μμΌλ©΄ ν•΄λ‹Ή ESNI λ μ½”λ“λ¥Ό λ¬΄μ‹ν•΄μ•Όν•λ‹¤.</li></ul></li></ul><h4 id=μ¶”κ°€-μ •λ³΄>μ¶”κ°€ μ •λ³΄<a hidden class=anchor aria-hidden=true href=#μ¶”κ°€-μ •λ³΄>#</a></h4><p>μ„λ²„λ” μ—¬λ¬κ°μ ESNI λ μ½”λ“λ¥Ό μ κ³µν•¨μΌλ΅μ¨ μ—¬λ¬ λ²„μ „μ ESNIλ¥Ό μ κ³µν•  μ μλ‹¤. ESNI λ μ½”λ“λ“¤ μ¤‘ ν΄λΌμ΄μ–ΈνΈκ°€ λ¨λ¥΄λ” ESNI λ²„μ „μ„ κ°€μ§„ ESNI λ μ½”λ“κ°€ μλ‹¤λ©΄ ν΄λΌμ΄μ–ΈνΈλ” κ·Έ λ μ½”λ“λ¥Ό λ¬΄μ‹ν•΄μ•Όν•λ‹¤. ν•μ§€λ§ λ€λ¶€λ¶„μ μ„λ²„κ°€ ν•λ‚μ ESNI λ μ½”λ“λ§ μ „μ†΅ν•΄μ£Όλ” μƒνƒλ‹¤.</p><p>ESNI μ΄μ• 05 λ²„μ „μ—μ„ ESNIKeysλ” ESNIConfigλ΅ μ©μ–΄κ°€ λ³€κ²½λμ—λ‹¤. λν•, DNSλ¥Ό μ΄μ©ν•λ” λ°©λ²•μ€ <a href=https://tools.ietf.org/html/draft-nygren-dnsop-svcb-httpssvc-00>HTTPSSVC</a>λΌλ” DNSλ¥Ό μ΄μ©ν•΄μ„ μ¶”κ°€μ μΈ μ •λ³΄λ¥Ό μ κ³µν•λ” <a href=https://tools.ietf.org/html/draft-ietf-quic-transport>QUIC</a>, ESNI λ“± κΈ°μ λ“¤μ„ μ„ν• κΈ°μ μ„ μ‚¬μ©ν•λ” κ²ƒμΌλ΅ λ³€κ²½λμ—λ‹¤. ν•μ§€λ§ μ•„μ§κΉμ§„ 01 λ²„μ „ λ“± μ΄μ „ λ²„μ „μ μ΄μ•μΌλ΅ κµ¬ν„λμ–΄ μ΄μ©λκ³  μλ‹¤. ESNIλ„ κ·Έλ ‡κ³  HTTPSSVCλ„ κ·Έλ ‡κ³  μ•„μ§ μ΄μ•μΈ λ§νΌ μ–΄λ–»κ² λ³€κ²½λ μ§€λ” μ•„λ¬΄λ„ λ¨λ¥Έλ‹¤.</p><h3 id=esni-λ μ½”λ“μ—μ„-μ •λ³΄-μ·¨λ“ν•κΈ°>ESNI λ μ½”λ“μ—μ„ μ •λ³΄ μ·¨λ“ν•κΈ°<a hidden class=anchor aria-hidden=true href=#esni-λ μ½”λ“μ—μ„-μ •λ³΄-μ·¨λ“ν•κΈ°>#</a></h3><h4 id=esni-λ μ½”λ“-κ°€μ Έμ¤κΈ°>ESNI λ μ½”λ“ κ°€μ Έμ¤κΈ°<a hidden class=anchor aria-hidden=true href=#esni-λ μ½”λ“-κ°€μ Έμ¤κΈ°>#</a></h4><p>λ°μ΄ν„°λ¥Ό νμ‹±ν•  ENSI λ μ½”λ“λ” λ‹¤μ λ…λ Ήμ–΄λ΅ κ°€μ Έμ¬ μ μλ‹¤. μ•„λ λ…λ Ήμ–΄λ΅ κ°€μ Έμ¨ ESNI λ μ½”λ“λ” Base 64λ΅ μΈμ½”λ”©λμ–΄μλ” μƒνƒλ‹¤.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>nslookup -type<span class=o>=</span>txt _esni.cloudflare.com
</span></span></code></pre></div><h4 id=esni-λ μ½”λ“-λ””μ½”λ”©ν•κΈ°>ESNI λ μ½”λ“ λ””μ½”λ”©ν•κΈ°<a hidden class=anchor aria-hidden=true href=#esni-λ μ½”λ“-λ””μ½”λ”©ν•κΈ°>#</a></h4><p>ESNI λ μ½”λ“λ¥Ό μ²μ κ°€μ Έμ¤λ©΄ Base 64λ΅ μΈμ½”λ”©λμ–΄μλ‹¤. κ°€μ Έμ¨ ESNI λ μ½”λ“λ¥Ό λ””μ½”λ”©ν•΄μ„ μ‹¤μ  ESNI λ μ½”λ“ κ°’μ„ μ–»μ–΄λ‚Ό μ μλ‹¤. <a href=https://portswigger.net/burp>λ²„ν”„ μνΈ</a>μ Decoderλ¥Ό μ‚¬μ©ν•λ©΄ μ‰½κ² λ””μ½”λ”©ν•  μ μλ‹¤.</p><p><img loading=lazy src=decode-esni-record.png alt title="Decode ESNI record"></p><h4 id=esni-λ μ½”λ“μ—μ„-μ •λ³΄-μ·¨λ“ν•κΈ°-1>ESNI λ μ½”λ“μ—μ„ μ •λ³΄ μ·¨λ“ν•κΈ°<a hidden class=anchor aria-hidden=true href=#esni-λ μ½”λ“μ—μ„-μ •λ³΄-μ·¨λ“ν•κΈ°-1>#</a></h4><p><a href=#esni-%EB%A0%88%EC%BD%94%EB%93%9C-%EB%94%94%EC%BD%94%EB%94%A9%ED%95%98%EA%B8%B0>ESNI λ μ½”λ“ λ””μ½”λ”©ν•κΈ°</a>λ¥Ό ν†µν•΄ μ–»μ€ ESNI λ μ½”λ“λ” λ‹¤μκ³Ό κ°™λ‹¤.</p><pre tabindex=0><code>ff 01 13 0f a6 4a 00 24 00 1d 00 20 3f 3e c9 d5 
c4 62 f9 4e 1b 81 a3 cd f2 ca 4d bb 98 fa 78 2c 
cc 88 8b ce 82 98 1c 33 f6 12 c7 5f 00 02 13 01
01 04 00 00 00 00 5e 5a 1a 00 00 00 00 00 5e 62
03 00 00 00
</code></pre><p>DNSμ— μ¬λΌκ°€μλ” ESNI λ μ½”λ“λ” <a href=#esnikeys-%EA%B5%AC%EC%A1%B0%EC%B2%B4>ESNIKeys κµ¬μ΅°μ²΄</a>μ™€ λ‹¤λ¥΄κ² μ²΄ν¬μ„¬κ³Ό κΈΈμ΄ ν•„λ“λ“¤μ΄ μ¶”κ°€λμ–΄μλ‹¤. ESNI λ μ½”λ“μ λ¨λ“  μ«μ ν•μ‹ λ°μ΄ν„°μ λ°”μ΄νΈ μ¤λ”λ” λΉ… μ—”λ””μ–ΈμΌλ΅ λμ–΄μλ‹¤. ESNI λ μ½”λ“λ” μ•„λ ν…μ΄λΈ”κ³Ό κ°™μ€ κµ¬μ΅°λ¥Ό μ·¨ν•κ³  μλ‹¤.</p><p>ESNI λ μ½”λ“μ—μ„ μ •λ³΄λ¥Ό μ·¨λ“ν•  λ• ν•„λ“ λ³„λ΅ ν™•μΈν•  κ²ƒμ€ λ‹¤μκ³Ό κ°™λ‹¤.</p><ul><li>ESNIKeysμ μ²΄ν¬μ„¬μ„ 0μΌλ΅ μ±„μ΄ λ’¤ SHA 256μΌλ΅ ν•΄μ‰¬ν• ν•΄μ‰¬κ°’μ μµμƒμ„ 4λ°”μ΄νΈμ™€ κΈ°μ΅΄ μ²΄ν¬μ„¬μ΄ λ‹¤λ¥΄λ‹¤λ©΄ λ³€μ΅°λ λ°μ΄ν„°λ‹¤.</li><li>Keysλ” λ³µμμ KeyShareEntryλ΅ μ΄λ£¨μ–΄μ Έ μλ‹¤.</li><li>Not Before, Not Afterμ€ <a href=https://en.wikipedia.org/wiki/Unix_time>Unix time</a>μΌλ΅ λμ–΄μλ‹¤.</li></ul><p>μ„ κµ¬μ΅°λ¥Ό λ”°λΌ ESNI λ μ½”λ“μ—μ„ μ·¨λ“ν• μ •λ³΄λ” λ‹¤μκ³Ό κ°™λ‹¤.</p><h3 id=sni-μ•”νΈν™”-ν‚¤-μƒμ„±>SNI μ•”νΈν™” ν‚¤ μƒμ„±<a hidden class=anchor aria-hidden=true href=#sni-μ•”νΈν™”-ν‚¤-μƒμ„±>#</a></h3><p>SNIλ¥Ό μ•”νΈν™”ν•κΈ°μ— μ•μ„ μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•΄μ•Όν•λ‹¤. μ„λ²„λΌλ©΄ Client Helloλ΅, ν΄λΌμ΄μ–ΈνΈλΌλ©΄ DNSμ—μ„ λ°›μ•„μ¨ ESNIKeysλ΅ μƒλ€λ°©μ κ³µκ°ν‚¤λ¥Ό κ°€μ§€κ³  μμ„ κ²ƒμ΄λ‹¤. SNI μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±μ„ μ„ν•΄ μμ‹ μ κ°μΈν‚¤μ™€ μƒλ€λ°©μ κ³µκ°ν‚¤λ΅ κ³µμ  λΉ„λ°€μΈ ν‚¤λ¥Ό μ λ„ν•΄λ‚Έλ‹¤. OpenSSLμ„ μ‚¬μ©ν•  κ²½μ° <a href=https://www.openssl.org/docs/man1.0.2/man3/EVP_PKEY_derive.html>int EVP_PKEY_derive(EVP_PKEY_CTX *ctx, unsigned char *key, size_t *keylen)</a>λ¥Ό μ‚¬μ©ν•λ©΄ λκ³ , μ΄λ• μ λ„λ ν‚¤μΈ κ³µμ  λΉ„λ°€μ„ ZλΌκ³  ν•λ‹¤. κ·Έ ν›„ Zλ΅λ¶€ν„° <a href=https://tools.ietf.org/html/rfc5869>HKDF</a>μ„ μ΄μ©ν•μ—¬ SNI μ•”νΈν™” ν‚¤λ¥Ό μ•„λμ™€ κ°™μ΄ μƒμ„±ν•  μ μλ‹¤.</p><pre tabindex=0><code>Zx = HKDF-Extract(0, Z)
key = HKDF-Expand-Label(Zx, KeyLabel, Hash(ESNIContents), key_length)
iv = HKDF-Expand-Label(Zx, IVLabel, Hash(ESNIContents), iv_length)
</code></pre><p>μ²« Client Helloμ—λ” KeyLabelμ„ &ldquo;esni key"λ΅, IVLabelμ„ &ldquo;esni iv"λ΅ μ„¤μ •ν•λ‹¤. ν΄μ•„μ΄μ–ΈνΈμ λ‘ λ²μ§Έ Client Hello μ¦‰, μ²« λ²μ§Έ Client Helloμ— λ¬Έμ κ°€ μμ–΄μ„ Hello Retry Requestλ¥Ό λ³΄λ‚Έ/λ°›μ€ λ’¤μ—λ” KeyLabelμ„ &ldquo;hrr esni key"λ΅, IVLabelμ„ &ldquo;hrr esni iv"λ΅ μ„¤μ •ν•λ‹¤.</p><h3 id=sni-μ•”νΈν™”ν•κΈ°>SNI μ•”νΈν™”ν•κΈ°<a hidden class=anchor aria-hidden=true href=#sni-μ•”νΈν™”ν•κΈ°>#</a></h3><p><a href=#sni-%EC%95%94%ED%98%B8%ED%99%94-%ED%82%A4-%EC%83%9D%EC%84%B1>SNI μ•”νΈν™” ν‚¤ μƒμ„±</a> ν›„ μ•”νΈν™”μ— ν•„μ”ν• κ²ƒμ€ λ‹¤μκ³Ό κ°™λ‹¤.</p><ul><li>Record Digest: μ•”νΈν™”ν•  λ• μ‚¬μ©ν• ESNIKeysμ ν•΄μ‰¬κ°’</li><li>ESNI Key Share: SNI μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•  λ• μ‚¬μ©λ μμ‹ μ κ³µκ°ν‚¤</li><li>TLS Key Share: Client Hello &ldquo;key_share&rdquo; extensionμ— μλ” μμ‹ μ κ³µκ°ν‚¤<ul><li>cut-and-paste κ³µκ²©μ„ λ°©μ§€ν•κΈ° μ„ν•΄μ„ AADλ΅ μ‚¬μ©ν•λ‹¤.</li></ul></li><li>λλ¤: Client Helloμ λλ¤</li></ul><p>μ„ μ”μ†κ°€ μ¤€λΉ„λμ—λ‹¤λ©΄ ν΄λΌμ΄μ–ΈνΈλ” μ•”νΈν™”ν•  μ„λ²„ μ΄λ¦„μ— ν¨λ”©μ„ μ μ©ν•κ³  CientESNIInner κ°μ²΄λ¥Ό λ§λ“¤μ–΄μ•Ό ν•λ‹¤. ν¨λ”©μ„ ν• ν›„ κΈΈμ΄κ°€ ESNIKeysμ padded_lengthμ™€ κ°™μ•„μ•Ό ν•λ‹¤.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>opaque</span> <span class=n>dns_name</span><span class=o>&lt;</span><span class=mf>1..2</span><span class=o>^</span><span class=mi>16</span><span class=o>-</span><span class=mi>1</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>opaque</span> <span class=n>zeros</span><span class=p>[</span><span class=n>ESNIKeys</span><span class=p>.</span><span class=n>padded_length</span> <span class=o>-</span> <span class=nf>length</span><span class=p>(</span><span class=n>dns_name</span><span class=p>)];</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>PaddedServerNameList</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>uint8</span> <span class=n>nonce</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>PaddedServerNameList</span> <span class=n>realSNI</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>ClientESNIInner</span><span class=p>;</span>
</span></span></code></pre></div><ul><li>nonce: μ„λ²„λ΅λ¶€ν„° λλλ ¤ λ³΄λ‚΄μ§ λλ¤ν• 16 λ°”μ΄νΈ κ°’</li><li>dns_name: server_name extensionμ— λ“¤μ–΄κ°€λ” μ„λ²„ μ΄λ¦„ λ©λ΅</li><li>zeros: 0μΌλ΅ λ ν¨λ”©. ν¨λ”©μ ν¬κΈ°λ” ESNIKeysμ padded_lengthμ— μν•΄ κ²°μ •λλ‹¤.</li></ul><p>ClientESNIInnerκ°€ μ¤€λΉ„λμ—λ‹¤λ©΄ μ΄ κ°’μ„ AEAD-Encryptλ΅ μ•”νΈν™”ν•λ©΄ λλ‹¤.</p><p>μμ„Έν• λ‚΄μ©μ€ <a href=https://tools.ietf.org/html/draft-ietf-tls-esni-05#section-5.1.1>ESNI μ΄μ• 5.1.1 μ•”νΈν™”λ SNI λ³΄λ‚΄κΈ°</a> μ°Έκ³ </p><p>GitHub <a href=https://github.com/sftcd/openssl/blob/ESNI-and-ECH/ssl/esni.c>sftcd/openssl</a> λ¦¬ν¬μ§€ν† λ¦¬μ— ESNI μ•”νΈν™”/λ³µνΈν™” ν•¨μκ°€ κµ¬ν„λμ–΄ μλ‹¤.</p><h3 id=μ•”νΈν™”λ-sniλ¥Ό-λ³µνΈν™”ν•κΈ°>μ•”νΈν™”λ SNIλ¥Ό λ³µνΈν™”ν•κΈ°<a hidden class=anchor aria-hidden=true href=#μ•”νΈν™”λ-sniλ¥Ό-λ³µνΈν™”ν•κΈ°>#</a></h3><p><a href=#sni-%EC%95%94%ED%98%B8%ED%99%94%ED%95%98%EA%B8%B0>SNI μ•”νΈν™”ν•κΈ°</a>μ—μ„ μ•”νΈν™”μ— μ‚¬μ©λ λ¨λ“  λ°μ΄ν„°λ” Client Helloμ— λ“¤μ–΄μλ‹¤. <a href=#sni-%EC%95%94%ED%98%B8%ED%99%94-%ED%82%A4-%EC%83%9D%EC%84%B1>SNI μ•”νΈν™” ν‚¤ μƒμ„±</a> μ΄ν›„ Client Helloμ— μλ” &ldquo;encrypted_server_name&rdquo; extensionκ³Ό Random, &ldquo;key_share&rdquo; extensionμ„ κ°€μ Έμ™€μ„ AEAD-Decrypt ν•λ©΄ λ³µνΈν™”κ°€ κ°€λ¥ν•λ‹¤.</p><h2 id=esniλ¥Ό-μ‚¬μ©ν•λ©΄-μ ν•΄μ‚¬μ΄νΈ-μ°¨λ‹¨μ΄-μ–΄λ ¤μ΄-μ΄μ >ESNIλ¥Ό μ‚¬μ©ν•λ©΄ μ ν•΄μ‚¬μ΄νΈ μ°¨λ‹¨μ΄ μ–΄λ ¤μ΄ μ΄μ <a hidden class=anchor aria-hidden=true href=#esniλ¥Ό-μ‚¬μ©ν•λ©΄-μ ν•΄μ‚¬μ΄νΈ-μ°¨λ‹¨μ΄-μ–΄λ ¤μ΄-μ΄μ >#</a></h2><p>μ°λ¦¬λ‚λΌμ—μ„λ” μ ν•΄μ‚¬μ΄νΈ μ°¨λ‹¨μ„ ν•κ³  μκ³ , μ—¬λ¬ νμ‚¬μ—μ„λ„ λΉ„μ—…λ¬΄μ‚¬μ΄νΈλ¥Ό λ§‰κΈ° μ„ν•΄ λ…Έλ ¥ν•κ³  μλ‹¤. ν•μ§€λ§, ESNIκ°€ λ³Έκ²©μ μΌλ΅ μ μ©λλ©΄ μ§€κΈκΉμ§€ μ μ©ν•κ³  μλ μ°¨λ‹¨ λ°©λ²•λ“¤μ€ μ‚¬μ©ν•κΈ° μ–΄λ ¤μΈ κ²ƒμ΄λ‹¤. μΌλ‹¨ μ°λ¦¬λ‚λΌμ κ²½μ° μ°¨λ‹¨ λ°©μ‹μΌλ΅ μ •κ³µλ²•μ΄ μ•„λ‹ κΌΌμλ¥Ό μ΄μ©ν• μ°¨λ‹¨μ„ ν•μ§„ λ»ν•  κ²ƒμ΄λ‹¤. κΌΌμλ΅ μ°¨λ‹¨μ„ μ§„ν–‰ν•λ‹¤λ©΄ μ–Έμ λ“ μ§€ ν¨μΉλ  κ°€λ¥μ„±μ΄ μκΈ° λ•λ¬Έμ— κ²°κµ­ κ³ λ ¤ν•  μ μλ” λ°©λ²•μ€ μ •κ³µλ²•μΈ <a href=#esni-mitm>ESNI MITM</a>μΈλ° λ³΄λ©΄ μ•κ² μ§€λ§ κµ­κ°€ λ‹¨μ„λ΅ νΉν μ°λ¦¬λ‚λΌμ—μ„ μ μ©ν•κΈ΄ μ–΄λ ¤μ΄ κΈ°μ μ΄λ‹¤.</p><p>νμ‚¬λ“¤μ κ²½μ° SSL κ°€μ‹μ„±μ„ ν™•λ³΄ν•λ” ν•νƒλ΅ λΉ„μ—…λ¬΄μ‚¬μ΄νΈλ¥Ό μ°¨λ‹¨ν•κ³  μμ„ κ²ƒμΈλ°, κ²°κµ­ HTTPS ν†µμ‹ μ— λ¬Έμ κ°€ μ—†κ² ν•κΈ° μ„ν•΄μ„ λ£¨νΈ μΈμ¦μ„λ¥Ό μ„¤μΉν•΄λ‘λ”λΌλ„ SSL κ°€μ‹μ„± ν™•λ³΄ μ¥λΉ„μ—μ„ SNIλ¥Ό ν™•μΈν•λ” ν•νƒλ΅ λ”°λ΅ μ ‘μ†ν•λ” μ‚¬μ΄νΈμ— λ€ν• μΈμ¦μ„λ¥Ό λ°°ν¬ν•κ³  μμ„ κ²ƒμ΄λ‹¤. ν•μ§€λ§, μΈμ¦μ„λ¥Ό λ°°ν¬ν•κΈ°μ„ν•΄ μ°Έκ³ ν•κ³  μλ SNIκ°€ μ•”νΈν™”λμ–΄λ²„λ¦¬λ‹ SSL κ°€μ‹μ„± μ¥λΉ„μ—μ„ <a href=#esni-mitm>ESNI MITM</a> κΈ°λ¥μ„ μ κ³µν•΄μ•Όν•  κ²ƒμ΄λ‹¤.</p><h2 id=esniκ°€-μ‚¬μ©λ-ν†µμ‹ μ„-μ°¨λ‹¨ν•λ”-λ°©λ²•>ESNIκ°€ μ‚¬μ©λ ν†µμ‹ μ„ μ°¨λ‹¨ν•λ” λ°©λ²•<a hidden class=anchor aria-hidden=true href=#esniκ°€-μ‚¬μ©λ-ν†µμ‹ μ„-μ°¨λ‹¨ν•λ”-λ°©λ²•>#</a></h2><h3 id=dohλ¥Ό-μ°¨λ‹¨ν•λ”-λ°©λ²•>DoHλ¥Ό μ°¨λ‹¨ν•λ” λ°©λ²•<a hidden class=anchor aria-hidden=true href=#dohλ¥Ό-μ°¨λ‹¨ν•λ”-λ°©λ²•>#</a></h3><p>ν„μ¬κΉμ§€ ESNIλ¥Ό κ³µμ‹μ μΌλ΅ μ§€μ›ν•λ” λΈλΌμ°μ €λ” Firefoxλ°–μ— μ—†λ‹¤. Firefoxλ” DoHλ¥Ό μ‚¬μ©ν•μ§€ μ•μΌλ©΄ ESNIλ¥Ό μ‚¬μ©ν•  μ μ—†κ² λμ–΄μκΈ° λ•λ¬Έμ— DoHλ§ μ°¨λ‹¨ν•΄λ„ μ‰½κ² ESNIλ¥Ό μ°¨λ‹¨ν•  μ μλ‹¤. λ¬Όλ΅ , μ •κ³µλ²•μ΄ μ•„λ‹ κΌΌμμΈλ°λ‹¤ λ‹¤λ¥Έ λΈλΌμ°μ €λ“¤μ΄ ESNIλ¥Ό μ§€μ›ν•κ³  κ·Έ λΈλΌμ°μ €λ“¤ μ¤‘ DoHκ°€ ν•„μ μµμ…μ΄ μ•„λ‹ λΈλΌμ°μ €κ°€ μλ‹¤λ©΄ ν¨κ³Όκ°€ μ—†μ„ κ²ƒμ΄λ‹¤.</p><h3 id=esniλ¥Ό-mitmν•λ”-λ°©λ²•>ESNIλ¥Ό MITMν•λ” λ°©λ²•<a hidden class=anchor aria-hidden=true href=#esniλ¥Ό-mitmν•λ”-λ°©λ²•>#</a></h3><p>μΌλ‹¨, ν΄λΌμ΄μ–ΈνΈκ°€ ESNI λ μ½”λ“λ¥Ό DNS μ„λ²„μ— μ”μ²­ν–μ„ λ• λ‚΄κ°€ λ§λ“  ESNI λ μ½”λ“λ¥Ό μ‘λ‹µν•΄μ•Ό ν•λ‹¤. μ”μ²­ ν¨ν‚·μ€ λ‚΄κ°€ λ¬΄μ΅°κ±΄ DNS μ„λ²„λ³΄λ‹¤ λ¨Όμ € μ‘λ‹µν•΄μ¤„ μ μλ‹¤λ©΄ λ‚λ‘¬λ„ λμ§€λ§ μ•„λ‹λΌλ©΄ λ“λν•λ„λ΅ ν•λ‹¤. λ‚λ¨Έμ§€λ” λ„λ¦¬ μ•λ ¤μ§„ TLS MITMκ³Ό λΉ„μ·ν• λ°©μ‹μΌλ΅ λ™μ‘ν•λ‹¤. ν΄λΌμ΄μ–ΈνΈκ°€ SNIλ¥Ό μ•”νΈν™”ν–λ”λΌλ„ λ‚΄κ°€ μ‘λ‹µν•΄μ¤€ ESNI λ μ½”λ“(ν‚¤)λ¥Ό μ‚¬μ©ν•΄μ„ μ•”νΈν™”ν–κΈ° λ•λ¬Έμ— μ¤‘κ°„μ—μ„ λ³µνΈν™”ν•  μ μλ‹¤. ν•μ§€λ§, κ·Έλ ‡λ‹¤κ³  κ·Έ Client Hello ν¨ν‚·μ„ κ·Έλ€λ΅ μ„λ²„μ—κ² λ³΄λ‚΄μ£Όλ©΄ μ„λ²„λ” SNIλ¥Ό λ³µνΈν™”ν•  μ μ—†κΈ° λ•λ¬Έμ— ν”„λ΅μ‹ λλ‚μΌλ΅ μ„λ²„λ΅ λ³„λ„λ΅ μ”μ²­ν•κ³  μ‘λ‹µμ„ λ°›μ•„μ™€μ•Όν•λ‹¤. κ·Έ ν›„ μ„λ²„λ΅λ¶€ν„° λ°›μ€ μ‘λ‹µμ„ κ·Έλ€λ΅ ν΄λΌμ΄μ–ΈνΈμ—κ² μ „λ‹¬ν•΄μ£Όλ©΄ λλ‹¤. λ³„λ„λ΅ μ„λ²„λ΅ μ”μ²­ν•  λ•λ” κµ³μ΄ ESNIλ¥Ό μ‚¬μ©ν•μ§€ μ•μ•„λ„ λλ‹¤. ESNI MITMμ΄ μ •μƒμ μΌλ΅ λ™μ‘ν•κΈ° μ„ν•΄μ„  μ–΄λ–¤ ν΄λΌμ΄μ–ΈνΈ(IP, Port)κ°€ μ–΄λ””λ΅ μ ‘μ†ν–λ”μ§€λ¥Ό λ¨λ‘ λ¶„μ„ν•΄μ„ κΈ°μ–µν•κ³  μμ–΄μ•Ό ν•λ‹¤.</p><p>ESNI MITMμ€ μ •κ³µλ²•μ΄κΈ° λ•λ¬Έμ— ESNIλ¥Ό μ‚¬μ©ν•λ”ν• μ°νν•  μ μ—†λ‹¤. ν•μ§€λ§, μ†κ·λ¨ λ„¤νΈμ›ν¬μ—λ” μ μ©ν•κΈ° μ‰½μ§€λ§, λ€κ·λ¨ λ„¤νΈμ›ν¬μ—λ” μ»΄ν“¨ν„° μμ› λ¬Έμ , λ¨λ“  λ„¤νΈμ›ν¬ νΈλν”½μ„ λ¶„μ„ν•΄μ•Ό λλ‹¤λ” λ¬Έμ  λ•λ¬Έμ— μ μ©ν•κΈ° μ–΄λ µλ‹¤. λ¬Όλ΅  ISPλ” λ§μλ§ λ¨ΉμΌλ©΄ λ¨λ“  λ„¤νΈμ›ν¬ νΈλν”½μ„ ν™•μΈν•  μ μμ§€λ§, λ¬΄μ—‡λ³΄λ‹¤ MITMμ€ μ—„μ—°ν ν•΄ν‚Ήμ΄κΈ° λ•λ¬Έμ— λ²•μ μΌλ΅λ„ μ ν•΄μ‚¬μ΄νΈ μ°¨λ‹¨ λ°©λ²•μΌλ΅λ” μ‚¬μ©ν•  μ μ—†μ„ κ²ƒμ΄λ‹¤. λ¨λ“  κ²ƒμ„ κ°μν•λ”λΌλ„ QoS λ•λ¬Έμ— ISPμ—μ„λ” μ λ€ λ¬Έμ κ°€ μƒκΈΈ μ μλ” In-Path λ°©μ‹μ μ†”λ£¨μ…μ€ μ μ©ν•μ§€ λ»ν•  κ²ƒμ΄λ‹¤.</p><h3 id=tls-μΈμ¦μ„λ¥Ό-μ΄μ©ν•λ”-λ°©λ²•>TLS μΈμ¦μ„λ¥Ό μ΄μ©ν•λ” λ°©λ²•<a hidden class=anchor aria-hidden=true href=#tls-μΈμ¦μ„λ¥Ό-μ΄μ©ν•λ”-λ°©λ²•>#</a></h3><p>HTTPS ν†µμ‹ μ„ μ°¨λ‹¨ν•λ” λ°©λ²•μ€ SNIλ¥Ό μ΄μ©ν•λ” λ°©λ²• μ™Έμ—λ„ μΈμ¦μ„μ— μλ” Issued Toμ CN ν•„λ“λ¥Ό μ΄μ©ν•λ” λ°©λ²•λ„ μλ‹¤. ν•μ§€λ§, ESNIκ°€ μ‚¬μ©κ°€λ¥ν• TLS 1.3 λ¶€ν„°λ” μΈμ¦μ„λ„ μ•”νΈν™”ν•΄μ„ μ „μ†΅ν•κΈ° λ•λ¬Έμ— μΌλ°μ μΈ λ°©λ²•μΌλ΅λ” μ‚¬μ©μ΄ λ¶κ°€λ¥ν•λ‹¤. ν„μ¬λ” ν¨μΉλμ–΄ μ‚¬μ©ν•  μ μ—†λ” λ°©λ²•μ΄μ§€λ§ μ›λ¦¬λ” λ‹¤μκ³Ό κ°™λ‹¤.</p><p><img loading=lazy src=tls-certificate.png alt title="TLS certificate"></p><p>TLS μΈμ¦μ„λ¥Ό ν‰λ¬ΈμΌλ΅ λ°›μ•„λ³΄κΈ° μ„ν•΄μ„  TLSμ λ²„μ „μ„ λ‹¤μ΄κ·Έλ μ΄λ“ν•΄μ•Ό ν•λ‹¤. TLS ν†µμ‹  μ¤‘ Client Hello ν¨ν‚·μ„ λ³΄λ©΄ supported_versions extensionμ΄ ν¬ν•¨λμ–΄ μλ”λ°, μ΄ λ°μ΄ν„°λ΅ μ‹¤μ  TLS ν†µμ‹ μ λ²„μ „μ΄ κ²°μ •λλ‹¤. supported_versions extensionμ— μλ” λ²„μ „ λ©λ΅μ—μ„ TLS 1.3μ„ μ κ±°ν• ν›„ Client Hello ν¨ν‚·μ„ ESNI μ„λ²„μ— λ³΄λ‚Έλ‹¤λ©΄, ESNI μ„λ²„λ” μ•”νΈν™”λ SNIλ¥Ό λ³µνΈν™”ν•΄μ„ SNIλ¥Ό μ–»μ–΄λ‚Έ ν›„ μ‚¬μ©ν•  μ μλ” λ²„μ „ μ¤‘ κ°€μ¥ λ†’μ€ TLS 1.2λ΅ ν†µμ‹ μ„ μ§„ν–‰ν•λ‹¤. TLS 1.2λ” μΈμ¦μ„λ¥Ό μ•”νΈν™”ν•μ§€ μ•κΈ° λ•λ¬Έμ— μ•μ„ λ§ν• Issued Toμ μ •λ³΄λ¥Ό μ΄μ©ν•΄μ„ μ°¨λ‹¨μ΄ κ°€λ¥ν•λ‹¤.</p><p><img loading=lazy src=supported-version-extension.png alt title="supported_version extension"></p><p>μ§μ ‘ ESNI ν¨ν‚·μ„ λ°μƒμ‹ν‚¤μ§€ μ•κ³ λ„ κ°€λ¥ν•λ°, encrypted_sni extensionμ΄ ν¬ν•¨λ ν¨ν‚·μ—μ„ TLS 1.3μ„ μ κ±°ν• ν›„ κ·Έλ€λ΅ μ „μ†΅ν•΄λ„ μ•”νΈν™”λμ§€ μ•μ€ μΈμ¦μ„λ¥Ό λ°›μ•„λ³Ό μ μλ‹¤. νΈλ²•μ΄κΈ° λ•λ¬Έμ— ν¨μΉλμ—μ§€λ§, ν¨μΉλμ§€ μ•μ•λ‹¤λ©΄ HTTPS μ°¨λ‹¨ λ°©λ²•μΌλ΅λ„ μ΄μ©μ΄ κ°€λ¥ν–μ„ κ²ƒμ΄λ‹¤.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://pol4.dev/tags/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EB%B3%B4%EC%95%88/>λ„¤νΈμ›ν¬ λ³΄μ•</a></li><li><a href=https://pol4.dev/tags/esni/>ESNI</a></li><li><a href=https://pol4.dev/tags/%EC%9C%A0%ED%95%B4%EC%82%AC%EC%9D%B4%ED%8A%B8-%EC%B0%A8%EB%8B%A8/>μ ν•΄μ‚¬μ΄νΈ μ°¨λ‹¨</a></li></ul><nav class=paginav><a class=prev href=https://pol4.dev/posts/about-harmful-website-blocking-in-korea/><span class=title>Β« μ΄μ „ νμ΄μ§€</span><br><span>μ ν•΄μ‚¬μ΄νΈ μ°¨λ‹¨μ— λ€ν•΄μ„</span>
</a><a class=next href=https://pol4.dev/posts/esni-vulnerability-bug-bounty/><span class=title>λ‹¤μ νμ΄μ§€ Β»</span><br><span>ESNI λ¬΄λ ¥ν™” μ·¨μ•½μ  λ²„κ·Έ λ°”μ΄ν‹° ν›„κΈ°</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI on x" href="https://x.com/intent/tweet/?text=%ec%95%8c%ec%95%84%eb%91%ac%eb%8f%84%20%ec%93%b8%eb%8d%b0%ec%97%86%eb%8a%94%20%ec%8b%a0%eb%b9%84%ed%95%9c%20ESNI&amp;url=https%3a%2f%2fpol4.dev%2fposts%2fwhat-is-esni%2f&amp;hashtags=%eb%84%a4%ed%8a%b8%ec%9b%8c%ed%81%ac%eb%b3%b4%ec%95%88%2cESNI%2c%ec%9c%a0%ed%95%b4%ec%82%ac%ec%9d%b4%ed%8a%b8%ec%b0%a8%eb%8b%a8"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fpol4.dev%2fposts%2fwhat-is-esni%2f&amp;title=%ec%95%8c%ec%95%84%eb%91%ac%eb%8f%84%20%ec%93%b8%eb%8d%b0%ec%97%86%eb%8a%94%20%ec%8b%a0%eb%b9%84%ed%95%9c%20ESNI&amp;summary=%ec%95%8c%ec%95%84%eb%91%ac%eb%8f%84%20%ec%93%b8%eb%8d%b0%ec%97%86%eb%8a%94%20%ec%8b%a0%eb%b9%84%ed%95%9c%20ESNI&amp;source=https%3a%2f%2fpol4.dev%2fposts%2fwhat-is-esni%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fpol4.dev%2fposts%2fwhat-is-esni%2f&title=%ec%95%8c%ec%95%84%eb%91%ac%eb%8f%84%20%ec%93%b8%eb%8d%b0%ec%97%86%eb%8a%94%20%ec%8b%a0%eb%b9%84%ed%95%9c%20ESNI"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fpol4.dev%2fposts%2fwhat-is-esni%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI on whatsapp" href="https://api.whatsapp.com/send?text=%ec%95%8c%ec%95%84%eb%91%ac%eb%8f%84%20%ec%93%b8%eb%8d%b0%ec%97%86%eb%8a%94%20%ec%8b%a0%eb%b9%84%ed%95%9c%20ESNI%20-%20https%3a%2f%2fpol4.dev%2fposts%2fwhat-is-esni%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI on telegram" href="https://telegram.me/share/url?text=%ec%95%8c%ec%95%84%eb%91%ac%eb%8f%84%20%ec%93%b8%eb%8d%b0%ec%97%86%eb%8a%94%20%ec%8b%a0%eb%b9%84%ed%95%9c%20ESNI&amp;url=https%3a%2f%2fpol4.dev%2fposts%2fwhat-is-esni%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share μ•μ•„λ‘¬λ„ μ“Έλ°μ—†λ” μ‹ λΉ„ν• ESNI on ycombinator" href="https://news.ycombinator.com/submitlink?t=%ec%95%8c%ec%95%84%eb%91%ac%eb%8f%84%20%ec%93%b8%eb%8d%b0%ec%97%86%eb%8a%94%20%ec%8b%a0%eb%b9%84%ed%95%9c%20ESNI&u=https%3a%2f%2fpol4.dev%2fposts%2fwhat-is-esni%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://pol4.dev>Pol4bear's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>